<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veritabanı Test - Kampanya Takip Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }
        .test-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .loading {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Üst Menü -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container-fluid">
                <a class="navbar-brand text-center w-100" href="#">
                    <i class="fas fa-database me-2"></i>
                    Veritabanı Test Paneli
                </a>
            </div>
        </nav>

        <!-- Ana İçerik -->
        <div class="container mt-4">
            <div class="row">
                <div class="col-12">
                    <div class="alert alert-info">
                        <h4><i class="fas fa-info-circle me-2"></i>Veritabanı Test Paneli</h4>
                        <p class="mb-0">Bu sayfa Supabase veritabanı bağlantınızı ve tablolarınızı test eder.</p>
                    </div>
                </div>
            </div>

            <!-- Test Butonları -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-play me-2"></i>Test İşlemleri</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 mb-2">
                                    <button class="btn btn-primary w-100" onclick="testConnection()">
                                        <i class="fas fa-plug me-2"></i>Bağlantı Testi
                                    </button>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <button class="btn btn-success w-100" onclick="testTables()">
                                        <i class="fas fa-table me-2"></i>Tablo Testi
                                    </button>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <button class="btn btn-warning w-100" onclick="testData()">
                                        <i class="fas fa-database me-2"></i>Veri Testi
                                    </button>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <button class="btn btn-info w-100" onclick="runAllTests()">
                                        <i class="fas fa-play-circle me-2"></i>Tüm Testler
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Sonuçları -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Test Sonuçları</h5>
                        </div>
                        <div class="card-body">
                            <div id="test-results">
                                <div class="text-center text-muted">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Test başlatmak için yukarıdaki butonlardan birini tıklayın.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Veritabanı Bilgileri -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info me-2"></i>Veritabanı Bilgileri</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Supabase Bağlantı Bilgileri</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>URL:</strong> <code id="supabase-url">-</code></li>
                                        <li><strong>Durum:</strong> <span id="connection-status" class="text-muted">Test edilmedi</span></li>
                                        <li><strong>Son Test:</strong> <span id="last-test" class="text-muted">-</span></li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Tablo Durumu</h6>
                                    <ul class="list-unstyled" id="table-status">
                                        <li class="text-muted">Test edilmedi</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script>
        // Test sonuçlarını göstermek için fonksiyon
        function showTestResult(message, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result test-${type}`;
            resultDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle'} me-2"></i>
                ${message}
            `;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // Test sonuçlarını temizle
        function clearTestResults() {
            document.getElementById('test-results').innerHTML = '';
        }

        // Bağlantı testi
        async function testConnection() {
            clearTestResults();
            showTestResult('Supabase bağlantısı test ediliyor...', 'info');
            
            try {
                // Önce Supabase bağlantısının var olup olmadığını kontrol et
                if (typeof supabase === 'undefined') {
                    showTestResult('HATA: Supabase bağlantısı bulunamadı! supabase-config.js dosyası yüklenmemiş.', 'error');
                    document.getElementById('connection-status').innerHTML = '<span class="text-danger">Bağlantı Yok</span>';
                    return;
                }
                
                showTestResult('Supabase bağlantısı bulundu, test ediliyor...', 'info');
                
                // Basit bir test sorgusu
                const { data, error } = await supabase
                    .from('regions')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    showTestResult(`Bağlantı hatası: ${error.message}`, 'error');
                    showTestResult(`Hata kodu: ${error.code}`, 'error');
                    showTestResult(`Hata detayı: ${JSON.stringify(error)}`, 'error');
                    document.getElementById('connection-status').innerHTML = '<span class="text-danger">Hata</span>';
                } else {
                    showTestResult('Supabase bağlantısı başarılı!', 'success');
                    document.getElementById('connection-status').innerHTML = '<span class="text-success">Bağlı</span>';
                }
            } catch (err) {
                showTestResult(`Bağlantı hatası: ${err.message}`, 'error');
                showTestResult(`Hata detayı: ${err.stack}`, 'error');
                document.getElementById('connection-status').innerHTML = '<span class="text-danger">Hata</span>';
            }
            
            document.getElementById('last-test').textContent = new Date().toLocaleString('tr-TR');
        }

        // Tablo testi
        async function testTables() {
            clearTestResults();
            showTestResult('Tablolar test ediliyor...', 'info');
            
            const tables = ['regions', 'channels', 'users', 'stores', 'tasks', 'task_responses', 'game_plans'];
            const tableStatus = document.getElementById('table-status');
            tableStatus.innerHTML = '';
            
            let allTablesOk = true;
            
            for (const table of tables) {
                try {
                    const { data, error } = await supabase
                        .from(table)
                        .select('*')
                        .limit(1);
                    
                    if (error) {
                        showTestResult(`❌ ${table} tablosu hatası: ${error.message}`, 'error');
                        tableStatus.innerHTML += `<li class="text-danger">❌ ${table}</li>`;
                        allTablesOk = false;
                    } else {
                        showTestResult(`✅ ${table} tablosu OK`, 'success');
                        tableStatus.innerHTML += `<li class="text-success">✅ ${table}</li>`;
                    }
                } catch (err) {
                    showTestResult(`❌ ${table} tablosu hatası: ${err.message}`, 'error');
                    tableStatus.innerHTML += `<li class="text-danger">❌ ${table}</li>`;
                    allTablesOk = false;
                }
            }
            
            if (allTablesOk) {
                showTestResult('🎉 Tüm tablolar başarıyla test edildi!', 'success');
            } else {
                showTestResult('⚠️ Bazı tablolarda sorun var. Lütfen Supabase SQL Editor\'da supabase_rls_fix.sql dosyasını çalıştırın.', 'warning');
            }
        }

        // Veri testi
        async function testData() {
            clearTestResults();
            showTestResult('Veri testi başlatılıyor...', 'info');
            
            try {
                // Bölgeleri test et
                const { data: regions, error: regionsError } = await supabase
                    .from('regions')
                    .select('*')
                    .limit(5);
                
                if (regionsError) {
                    showTestResult(`Bölgeler hatası: ${regionsError.message}`, 'error');
                } else {
                    showTestResult(`✅ Bölgeler: ${regions.length} kayıt bulundu`, 'success');
                }
                
                // Kanalları test et
                const { data: channels, error: channelsError } = await supabase
                    .from('channels')
                    .select('*')
                    .limit(5);
                
                if (channelsError) {
                    showTestResult(`Kanallar hatası: ${channelsError.message}`, 'error');
                } else {
                    showTestResult(`✅ Kanallar: ${channels.length} kayıt bulundu`, 'success');
                }
                
                // Kullanıcıları test et
                const { data: users, error: usersError } = await supabase
                    .from('users')
                    .select('*')
                    .limit(5);
                
                if (usersError) {
                    showTestResult(`Kullanıcılar hatası: ${usersError.message}`, 'error');
                } else {
                    showTestResult(`✅ Kullanıcılar: ${users.length} kayıt bulundu`, 'success');
                }
                
                // Mağazaları test et
                const { data: stores, error: storesError } = await supabase
                    .from('stores')
                    .select('*')
                    .limit(5);
                
                if (storesError) {
                    showTestResult(`Mağazalar hatası: ${storesError.message}`, 'error');
                } else {
                    showTestResult(`✅ Mağazalar: ${stores.length} kayıt bulundu`, 'success');
                }
                
                // Görevleri test et
                const { data: tasks, error: tasksError } = await supabase
                    .from('tasks')
                    .select('*')
                    .limit(5);
                
                if (tasksError) {
                    showTestResult(`Görevler hatası: ${tasksError.message}`, 'error');
                } else {
                    showTestResult(`✅ Görevler: ${tasks.length} kayıt bulundu`, 'success');
                }
                
            } catch (err) {
                showTestResult(`Veri testi hatası: ${err.message}`, 'error');
            }
        }

        // Tüm testleri çalıştır
        async function runAllTests() {
            clearTestResults();
            showTestResult('🚀 Tüm testler başlatılıyor...', 'info');
            
            await testConnection();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testTables();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testData();
            
            showTestResult('🏁 Tüm testler tamamlandı!', 'success');
        }

        // Sayfa yüklendiğinde Supabase URL'ini göster
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('supabase-url').textContent = window.SUPABASE_URL || 'Yüklenemedi';
        });
    </script>
</body>
</html>
