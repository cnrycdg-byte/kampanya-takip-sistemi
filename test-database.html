<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeritabanÄ± Test - Kampanya Takip Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }
        .test-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .loading {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Ãœst MenÃ¼ -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container-fluid">
                <a class="navbar-brand text-center w-100" href="#">
                    <i class="fas fa-database me-2"></i>
                    VeritabanÄ± Test Paneli
                </a>
            </div>
        </nav>

        <!-- Ana Ä°Ã§erik -->
        <div class="container mt-4">
            <div class="row">
                <div class="col-12">
                    <div class="alert alert-info">
                        <h4><i class="fas fa-info-circle me-2"></i>VeritabanÄ± Test Paneli</h4>
                        <p class="mb-0">Bu sayfa Supabase veritabanÄ± baÄŸlantÄ±nÄ±zÄ± ve tablolarÄ±nÄ±zÄ± test eder.</p>
                    </div>
                </div>
            </div>

            <!-- Test ButonlarÄ± -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-play me-2"></i>Test Ä°ÅŸlemleri</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 mb-2">
                                    <button class="btn btn-primary w-100" onclick="testConnection()">
                                        <i class="fas fa-plug me-2"></i>BaÄŸlantÄ± Testi
                                    </button>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <button class="btn btn-success w-100" onclick="testTables()">
                                        <i class="fas fa-table me-2"></i>Tablo Testi
                                    </button>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <button class="btn btn-warning w-100" onclick="testData()">
                                        <i class="fas fa-database me-2"></i>Veri Testi
                                    </button>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <button class="btn btn-info w-100" onclick="runAllTests()">
                                        <i class="fas fa-play-circle me-2"></i>TÃ¼m Testler
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test SonuÃ§larÄ± -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Test SonuÃ§larÄ±</h5>
                        </div>
                        <div class="card-body">
                            <div id="test-results">
                                <div class="text-center text-muted">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Test baÅŸlatmak iÃ§in yukarÄ±daki butonlardan birini tÄ±klayÄ±n.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VeritabanÄ± Bilgileri -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info me-2"></i>VeritabanÄ± Bilgileri</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Supabase BaÄŸlantÄ± Bilgileri</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>URL:</strong> <code id="supabase-url">-</code></li>
                                        <li><strong>Durum:</strong> <span id="connection-status" class="text-muted">Test edilmedi</span></li>
                                        <li><strong>Son Test:</strong> <span id="last-test" class="text-muted">-</span></li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Tablo Durumu</h6>
                                    <ul class="list-unstyled" id="table-status">
                                        <li class="text-muted">Test edilmedi</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script>
        // Test sonuÃ§larÄ±nÄ± gÃ¶stermek iÃ§in fonksiyon
        function showTestResult(message, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result test-${type}`;
            resultDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle'} me-2"></i>
                ${message}
            `;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // Test sonuÃ§larÄ±nÄ± temizle
        function clearTestResults() {
            document.getElementById('test-results').innerHTML = '';
        }

        // BaÄŸlantÄ± testi
        async function testConnection() {
            clearTestResults();
            showTestResult('Supabase baÄŸlantÄ±sÄ± test ediliyor...', 'info');
            
            try {
                // Ã–nce Supabase baÄŸlantÄ±sÄ±nÄ±n var olup olmadÄ±ÄŸÄ±nÄ± kontrol et
                if (typeof supabase === 'undefined') {
                    showTestResult('HATA: Supabase baÄŸlantÄ±sÄ± bulunamadÄ±! supabase-config.js dosyasÄ± yÃ¼klenmemiÅŸ.', 'error');
                    document.getElementById('connection-status').innerHTML = '<span class="text-danger">BaÄŸlantÄ± Yok</span>';
                    return;
                }
                
                showTestResult('Supabase baÄŸlantÄ±sÄ± bulundu, test ediliyor...', 'info');
                
                // Basit bir test sorgusu
                const { data, error } = await supabase
                    .from('regions')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    showTestResult(`BaÄŸlantÄ± hatasÄ±: ${error.message}`, 'error');
                    showTestResult(`Hata kodu: ${error.code}`, 'error');
                    showTestResult(`Hata detayÄ±: ${JSON.stringify(error)}`, 'error');
                    document.getElementById('connection-status').innerHTML = '<span class="text-danger">Hata</span>';
                } else {
                    showTestResult('Supabase baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±!', 'success');
                    document.getElementById('connection-status').innerHTML = '<span class="text-success">BaÄŸlÄ±</span>';
                }
            } catch (err) {
                showTestResult(`BaÄŸlantÄ± hatasÄ±: ${err.message}`, 'error');
                showTestResult(`Hata detayÄ±: ${err.stack}`, 'error');
                document.getElementById('connection-status').innerHTML = '<span class="text-danger">Hata</span>';
            }
            
            document.getElementById('last-test').textContent = new Date().toLocaleString('tr-TR');
        }

        // Tablo testi
        async function testTables() {
            clearTestResults();
            showTestResult('Tablolar test ediliyor...', 'info');
            
            const tables = ['regions', 'channels', 'users', 'stores', 'tasks', 'task_responses', 'game_plans'];
            const tableStatus = document.getElementById('table-status');
            tableStatus.innerHTML = '';
            
            let allTablesOk = true;
            
            for (const table of tables) {
                try {
                    const { data, error } = await supabase
                        .from(table)
                        .select('*')
                        .limit(1);
                    
                    if (error) {
                        showTestResult(`âŒ ${table} tablosu hatasÄ±: ${error.message}`, 'error');
                        tableStatus.innerHTML += `<li class="text-danger">âŒ ${table}</li>`;
                        allTablesOk = false;
                    } else {
                        showTestResult(`âœ… ${table} tablosu OK`, 'success');
                        tableStatus.innerHTML += `<li class="text-success">âœ… ${table}</li>`;
                    }
                } catch (err) {
                    showTestResult(`âŒ ${table} tablosu hatasÄ±: ${err.message}`, 'error');
                    tableStatus.innerHTML += `<li class="text-danger">âŒ ${table}</li>`;
                    allTablesOk = false;
                }
            }
            
            if (allTablesOk) {
                showTestResult('ğŸ‰ TÃ¼m tablolar baÅŸarÄ±yla test edildi!', 'success');
            } else {
                showTestResult('âš ï¸ BazÄ± tablolarda sorun var. LÃ¼tfen Supabase SQL Editor\'da supabase_rls_fix.sql dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n.', 'warning');
            }
        }

        // Veri testi
        async function testData() {
            clearTestResults();
            showTestResult('Veri testi baÅŸlatÄ±lÄ±yor...', 'info');
            
            try {
                // BÃ¶lgeleri test et
                const { data: regions, error: regionsError } = await supabase
                    .from('regions')
                    .select('*')
                    .limit(5);
                
                if (regionsError) {
                    showTestResult(`BÃ¶lgeler hatasÄ±: ${regionsError.message}`, 'error');
                } else {
                    showTestResult(`âœ… BÃ¶lgeler: ${regions.length} kayÄ±t bulundu`, 'success');
                }
                
                // KanallarÄ± test et
                const { data: channels, error: channelsError } = await supabase
                    .from('channels')
                    .select('*')
                    .limit(5);
                
                if (channelsError) {
                    showTestResult(`Kanallar hatasÄ±: ${channelsError.message}`, 'error');
                } else {
                    showTestResult(`âœ… Kanallar: ${channels.length} kayÄ±t bulundu`, 'success');
                }
                
                // KullanÄ±cÄ±larÄ± test et
                const { data: users, error: usersError } = await supabase
                    .from('users')
                    .select('*')
                    .limit(5);
                
                if (usersError) {
                    showTestResult(`KullanÄ±cÄ±lar hatasÄ±: ${usersError.message}`, 'error');
                } else {
                    showTestResult(`âœ… KullanÄ±cÄ±lar: ${users.length} kayÄ±t bulundu`, 'success');
                }
                
                // MaÄŸazalarÄ± test et
                const { data: stores, error: storesError } = await supabase
                    .from('stores')
                    .select('*')
                    .limit(5);
                
                if (storesError) {
                    showTestResult(`MaÄŸazalar hatasÄ±: ${storesError.message}`, 'error');
                } else {
                    showTestResult(`âœ… MaÄŸazalar: ${stores.length} kayÄ±t bulundu`, 'success');
                }
                
                // GÃ¶revleri test et
                const { data: tasks, error: tasksError } = await supabase
                    .from('tasks')
                    .select('*')
                    .limit(5);
                
                if (tasksError) {
                    showTestResult(`GÃ¶revler hatasÄ±: ${tasksError.message}`, 'error');
                } else {
                    showTestResult(`âœ… GÃ¶revler: ${tasks.length} kayÄ±t bulundu`, 'success');
                }
                
            } catch (err) {
                showTestResult(`Veri testi hatasÄ±: ${err.message}`, 'error');
            }
        }

        // TÃ¼m testleri Ã§alÄ±ÅŸtÄ±r
        async function runAllTests() {
            clearTestResults();
            showTestResult('ğŸš€ TÃ¼m testler baÅŸlatÄ±lÄ±yor...', 'info');
            
            await testConnection();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testTables();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testData();
            
            showTestResult('ğŸ TÃ¼m testler tamamlandÄ±!', 'success');
        }

        // Sayfa yÃ¼klendiÄŸinde Supabase URL'ini gÃ¶ster
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('supabase-url').textContent = window.SUPABASE_URL || 'YÃ¼klenemedi';
        });
    </script>
</body>
</html>
