/**
 * Yatƒ±rƒ±m Alanƒ± Raporu JavaScript - Tamamen Yeniden Yazƒ±ldƒ±
 * Filtreler ve grafikler d√ºzg√ºn √ßalƒ±≈üacak ≈üekilde optimize edildi
 */

let investmentReportData = {
    surveys: [],
    stores: [],
    regions: [],
    channels: [],
    brands: [],
    areasAnalysis: [],
    currentFilters: {
        surveys: [],
        region: '',
        channel: '',
        store: '',
        brand: []
    },
    filteredData: [],
    currentPage: 1,
    itemsPerPage: 25
};

// Sayfa y√ºklendiƒüinde √ßalƒ±≈üacak ana fonksiyon
async function initializeInvestmentReport() {
    let loadingId = null;
    try {
        console.log('üöÄ Yatƒ±rƒ±m Alanƒ± Raporu ba≈ülatƒ±lƒ±yor...');
        
        // Loading ba≈ülat
        loadingId = showLoading('Yatƒ±rƒ±m Alanƒ± Raporu Y√ºkleniyor', 'Veriler hazƒ±rlanƒ±yor...');
        
        // Verileri y√ºkle
        updateLoading(loadingId, 'Veriler Y√ºkleniyor', 'Anket ve maƒüaza verileri √ßekiliyor...');
        await loadInvestmentReportData();
        
        // Event listener'larƒ± kur
        updateLoading(loadingId, 'Sistem Hazƒ±rlanƒ±yor', 'Filtreler ve grafikler ayarlanƒ±yor...');
        setupEventListeners();
        
        // Filtreleri uygula
        updateLoading(loadingId, 'Son Hazƒ±rlƒ±klar', 'Filtreler uygulanƒ±yor...');
        await applyFilters();
        
        console.log('‚úÖ Yatƒ±rƒ±m Alanƒ± Raporu ba≈üarƒ±yla ba≈ülatƒ±ldƒ±');
    } catch (error) {
        console.error('‚ùå Yatƒ±rƒ±m Alanƒ± Raporu ba≈ülatma hatasƒ±:', error);
        showAlert('Yatƒ±rƒ±m Alanƒ± Raporu ba≈ülatƒ±lƒ±rken hata olu≈ütu', 'error');
    } finally {
        // Loading'i kapat
        if (loadingId) {
            hideLoading(loadingId);
        }
    }
}

// T√ºm verileri y√ºkle
async function loadInvestmentReportData() {
    console.log('üìä Yatƒ±rƒ±m Alanƒ± Raporu verileri y√ºkleniyor...');
    
    try {
        // Paralel olarak t√ºm verileri y√ºkle
        const [surveysResult, storesResult, regionsResult, channelsResult, brandsResult] = await Promise.all([
            supabase.from('surveys').select('*').order('created_at', { ascending: false }),
            supabase.from('stores').select('*').order('name'),
            supabase.from('regions').select('*').order('name'),
            supabase.from('channels').select('*').order('name'),
            supabase.from('brands').select('name').eq('status', 'active').order('name')
        ]);

        if (surveysResult.error) throw surveysResult.error;
        if (storesResult.error) throw storesResult.error;
        if (regionsResult.error) throw regionsResult.error;
        if (channelsResult.error) throw channelsResult.error;
        if (brandsResult.error) throw brandsResult.error;

        investmentReportData.surveys = surveysResult.data;
        investmentReportData.stores = storesResult.data;
        investmentReportData.regions = regionsResult.data;
        investmentReportData.channels = channelsResult.data;
        investmentReportData.brands = brandsResult.data.map(b => b.name);

        // Aktif anketleri belirle (survey_store_assignments tablosunda atamasƒ± olan anketler)
        const { data: assignments, error: assignmentError } = await supabase
            .from('survey_store_assignments')
            .select('survey_id')
            .order('survey_id');
        
        if (assignmentError) {
            console.warn('Survey assignments y√ºklenemedi:', assignmentError);
            console.log('‚ö†Ô∏è T√ºm anketler g√∂sterilecek (atama tablosu hatasƒ±)');
        } else {
            const activeSurveyIds = [...new Set(assignments.map(a => a.survey_id))];
            console.log('üîç Toplam atama sayƒ±sƒ±:', activeSurveyIds.length);
            console.log('üîç Aktif anket ID\'leri:', activeSurveyIds);
            
            // T√ºm anketleri g√∂ster (atamasƒ± olan + olmayan, sadece status = 'active' olan)
            investmentReportData.surveys = investmentReportData.surveys.filter(survey => 
                survey.status === 'active'
            );
            
            console.log('üîç Aktif anketler filtrelendi:', investmentReportData.surveys.length, 'anket');
            console.log('üîç Anket ba≈ülƒ±klarƒ±:', investmentReportData.surveys.map(s => s.title).join(', '));
        }

        console.log('üìã Anketler y√ºklendi:', investmentReportData.surveys.length);
        console.log('üè™ Maƒüazalar y√ºklendi:', investmentReportData.stores.length);
        console.log('üè∑Ô∏è B√∂lgeler y√ºklendi:', investmentReportData.regions.length);
        console.log('üè∑Ô∏è Kanallar y√ºklendi:', investmentReportData.channels.length);
        console.log('üè∑Ô∏è Markalar y√ºklendi:', investmentReportData.brands.length);
        
        // Debug: Anket detaylarƒ±nƒ± logla
        if (investmentReportData.surveys.length > 0) {
            console.log('üìã ƒ∞lk anket:', investmentReportData.surveys[0]);
        } else {
            console.warn('‚ö†Ô∏è Hi√ß aktif anket bulunamadƒ±!');
        }

        // Survey answers verilerini √ßek ve i≈üle
        await loadSurveyAnswersData();

        // Filtreleri doldur
        populateFilters();
        
        console.log('‚úÖ Veriler y√ºklendi:', investmentReportData.surveys.length, 'anket,', investmentReportData.stores.length, 'maƒüaza');
    } catch (error) {
        console.error('‚ùå Veri y√ºkleme hatasƒ±:', error);
        showAlert('Veri y√ºklenirken hata olu≈ütu: ' + error.message, 'error');
    }
}

// Survey answers verilerini y√ºkle
async function loadSurveyAnswersData() {
    console.log('üìä Survey answers verileri y√ºkleniyor...');
    
    try {
        const { data, error } = await supabase
            .from('survey_answers')
            .select('*, survey_responses(survey_id, store_id)')
            .order('created_at', { ascending: false })
            .limit(100);

        if (error) throw error;

        console.log('üìä Survey answers verisi y√ºklendi:', data.length, 'kayƒ±t');

        // Areas verilerini i≈üle
        const areasData = data.filter(item => {
            try {
                let answerData;
                if (typeof item.answer_data === 'string') {
                    answerData = JSON.parse(item.answer_data);
                } else {
                    answerData = item.answer_data;
                }
                return answerData && answerData.areas && Array.isArray(answerData.areas) && answerData.areas.length > 0;
            } catch (e) {
                return false;
            }
        });

        console.log('üìä Areas verisi filtrelendi:', areasData.length, 'kayƒ±t');

        const areasAnalysis = areasData.map(item => {
            let answerData;
            try {
                answerData = typeof item.answer_data === 'string' ? 
                    JSON.parse(item.answer_data) : item.answer_data;
            } catch (e) {
                return null;
            }
            
            // survey_response_id'yi kontrol et
            let surveyResponseId = item.survey_response_id || item.response_id;
            if (!surveyResponseId) {
                console.log('‚ö†Ô∏è survey_response_id bulunamadƒ±, item:', item);
                surveyResponseId = null;
            }
            
            // survey_id'yi survey_responses'dan al
            let surveyId = null;
            if (item.survey_responses && item.survey_responses.survey_id) {
                surveyId = item.survey_responses.survey_id;
            } else if (item.survey_id) {
                surveyId = item.survey_id;
            }
            
            // store_id'yi survey_responses'dan al
            let storeId = null;
            if (item.survey_responses && item.survey_responses.store_id) {
                storeId = item.survey_responses.store_id;
            }
            
            return {
                id: item.id,
                survey_response_id: surveyResponseId,
                survey_id: surveyId,
                store_id: storeId,
                areas_count: answerData.areas.length,
                areas: answerData.areas.map(area => ({
                    brand: area.brand,
                    area_type: area.area_type || (area.photos && area.photos.length > 0 ? 'wall' : 'middle'),
                    photos: area.photos || [],
                    photos_count: area.photos ? area.photos.length : 0
                }))
            };
        }).filter(Boolean);

        investmentReportData.areasAnalysis = areasAnalysis;
        console.log('‚úÖ Areas analizi tamamlandƒ±:', areasAnalysis.length, 'item');
        
        if (areasAnalysis.length === 0) {
            console.log('‚ö†Ô∏è Hi√ß veri yok, filtreler √ßalƒ±≈ümayacak');
        }
        
    } catch (error) {
        console.error('‚ùå Survey answers y√ºkleme hatasƒ±:', error);
        showAlert('Survey answers y√ºklenirken hata olu≈ütu: ' + error.message, 'error');
    }
}

// Filtreleri doldur
function populateFilters() {
    console.log('üîß Filtreler dolduruluyor...');
    
    // Anket se√ßimi
    const surveySelect = document.getElementById('filter-surveys-multi');
    if (surveySelect) {
        surveySelect.innerHTML = '<option value="">T√ºm Anketler</option>';
        investmentReportData.surveys.forEach(survey => {
            const option = document.createElement('option');
            option.value = survey.id;
            option.textContent = survey.title || `Anket ${survey.id}`;
            surveySelect.appendChild(option);
        });
        console.log('‚úÖ Anket filtresi dolduruldu:', investmentReportData.surveys.length, 'anket');
    } else {
        console.error('‚ùå filter-surveys-multi elementi bulunamadƒ±!');
    }

    // B√∂lge se√ßimi
    const regionSelect = document.getElementById('filter-region');
    if (regionSelect) {
        regionSelect.innerHTML = '<option value="">T√ºm B√∂lgeler</option>';
        investmentReportData.regions.forEach(region => {
            const option = document.createElement('option');
            option.value = region.id;
            option.textContent = region.name;
            regionSelect.appendChild(option);
        });
        console.log('‚úÖ B√∂lge filtresi dolduruldu:', investmentReportData.regions.length, 'b√∂lge');
    }

    // Kanal se√ßimi
    const channelSelect = document.getElementById('filter-channel');
    if (channelSelect) {
        channelSelect.innerHTML = '<option value="">T√ºm Kanallar</option>';
        investmentReportData.channels.forEach(channel => {
            const option = document.createElement('option');
            option.value = channel.id;
            option.textContent = channel.name;
            channelSelect.appendChild(option);
        });
        console.log('‚úÖ Kanal filtresi dolduruldu:', investmentReportData.channels.length, 'kanal');
    }

    // Maƒüaza se√ßimi
    const storeSelect = document.getElementById('filter-store');
    if (storeSelect) {
        storeSelect.innerHTML = '<option value="">T√ºm Maƒüazalar</option>';
        investmentReportData.stores.forEach(store => {
            const option = document.createElement('option');
            option.value = store.id;
            option.textContent = store.name;
            storeSelect.appendChild(option);
        });
        console.log('‚úÖ Maƒüaza filtresi dolduruldu:', investmentReportData.stores.length, 'maƒüaza');
    }

    // Marka se√ßimi
    const brandSelect = document.getElementById('filter-brand');
    if (brandSelect) {
        brandSelect.innerHTML = '<option value="">T√ºm Markalar</option>';
        investmentReportData.brands.forEach(brand => {
            const option = document.createElement('option');
            option.value = brand;
            option.textContent = brand;
            brandSelect.appendChild(option);
        });
        console.log('‚úÖ Marka filtresi dolduruldu:', investmentReportData.brands.length, 'marka');
    }
}

// Event listener'larƒ± kur
function setupEventListeners() {
    console.log('üîß Event listener\'lar kuruluyor...');
    
    // Filtre deƒüi≈üikliklerini dinle
    document.getElementById('filter-surveys-multi')?.addEventListener('change', applyFilters);
    document.getElementById('filter-region')?.addEventListener('change', applyFilters);
    document.getElementById('filter-channel')?.addEventListener('change', applyFilters);
    document.getElementById('filter-store')?.addEventListener('change', applyFilters);
    document.getElementById('filter-brand')?.addEventListener('change', applyFilters);
    document.getElementById('filter-area-type')?.addEventListener('change', applyFilters);
    
    // Arama kutusu
    document.getElementById('investment-store-search')?.addEventListener('input', updateStoreTable);
    
    // Filtreleri temizle butonu
    document.getElementById('clear-filters')?.addEventListener('click', () => {
        // T√ºm filtreleri sƒ±fƒ±rla
        document.getElementById('filter-surveys-multi').selectedIndex = 0;
        document.getElementById('filter-region').selectedIndex = 0;
        document.getElementById('filter-channel').selectedIndex = 0;
        document.getElementById('filter-store').selectedIndex = 0;
        document.getElementById('filter-brand').selectedIndex = 0;
        document.getElementById('filter-area-type').selectedIndex = 0;
        
        // Filtreleri uygula
        applyFilters();
    });
    
    // Sunum olu≈ütur butonu
    document.getElementById('create-presentation-btn')?.addEventListener('click', createPresentation);
    
    // Excel export butonu
    document.getElementById('export-investment-report')?.addEventListener('click', exportInvestmentToExcel);
    
    // Yenile butonu
    document.getElementById('refresh-investment-report')?.addEventListener('click', async () => {
        console.log('üîÑ Yatƒ±rƒ±m raporu yenileniyor...');
        await initializeInvestmentReport();
    });
    
    console.log('‚úÖ Event listener\'lar kuruldu');
}

// Filtreleri uygula
async function applyFilters() {
    let loadingId = null;
    try {
        console.log('üîç Filtreler uygulanƒ±yor...');
        
        // Loading ba≈ülat
        loadingId = showLoading('Filtreler Uygulanƒ±yor', 'Veriler filtreleniyor...');
        
        // Filtre deƒüerlerini g√ºncelle
        updateLoading(loadingId, 'Filtreler Uygulanƒ±yor', 'Filtre deƒüerleri g√ºncelleniyor...');
        updateFilterValues();
        
        console.log('üîç Aktif filtreler:', investmentReportData.currentFilters);
        
        // Filtrelenmi≈ü veriyi y√ºkle
        updateLoading(loadingId, 'Filtreler Uygulanƒ±yor', 'Veriler filtreleniyor...');
        await loadFilteredInvestmentData();
        
        // Grafikleri g√ºncelle
        updateLoading(loadingId, 'Filtreler Uygulanƒ±yor', 'Grafikler g√ºncelleniyor...');
        updateCharts();
        
        // Maƒüaza tablosunu g√ºncelle
        updateLoading(loadingId, 'Filtreler Uygulanƒ±yor', 'Tablo g√ºncelleniyor...');
        updateStoreTable();
        
        console.log('‚úÖ Filtreler ba≈üarƒ±yla uygulandƒ±');
    } catch (error) {
        console.error('‚ùå Filtre uygulama hatasƒ±:', error);
        showAlert('Filtreler uygulanƒ±rken hata olu≈ütu: ' + error.message, 'error');
    } finally {
        // Loading'i kapat
        if (loadingId) {
            hideLoading(loadingId);
        }
    }
}

// Filtre deƒüerlerini g√ºncelle
function updateFilterValues() {
    console.log('üîÑ Filtre deƒüerleri g√ºncelleniyor...');
    
    const surveySelect = document.getElementById('filter-surveys-multi');
    const regionSelect = document.getElementById('filter-region');
    const channelSelect = document.getElementById('filter-channel');
    const storeSelect = document.getElementById('filter-store');
    const brandSelect = document.getElementById('filter-brand');
    const areaTypeSelect = document.getElementById('filter-area-type');
    
    investmentReportData.currentFilters.surveys = Array.from(surveySelect?.selectedOptions || [])
        .map(opt => opt.value)
        .filter(value => value !== '');
    investmentReportData.currentFilters.region = regionSelect?.value || '';
    investmentReportData.currentFilters.channel = channelSelect?.value || '';
    investmentReportData.currentFilters.store = storeSelect?.value || '';
    investmentReportData.currentFilters.brand = Array.from(brandSelect?.selectedOptions || [])
        .map(opt => opt.value)
        .filter(value => value !== '');
    investmentReportData.currentFilters.areaType = areaTypeSelect?.value || '';
    
    console.log('üìã G√ºncel filtreler:', investmentReportData.currentFilters);
}

// Filtrelenmi≈ü veriyi y√ºkle
async function loadFilteredInvestmentData() {
    console.log('üìä Filtrelenmi≈ü yatƒ±rƒ±m verileri y√ºkleniyor...');
    
    try {
        // Areas analizi verilerini kullan
        let filteredData = [...(investmentReportData.areasAnalysis || [])];
        
        console.log('üîç Filtreleme ba≈ülƒ±yor, toplam veri:', filteredData.length);
        
        // Eƒüer veri yoksa, bo≈ü veri d√∂nd√ºr
        if (filteredData.length === 0) {
            console.warn('‚ö†Ô∏è Hi√ß veri yok, filtreleme yapƒ±lamƒ±yor');
            investmentReportData.filteredData = [];
            return;
        }
        
        // Anket filtresi
        if (investmentReportData.currentFilters.surveys.length > 0) {
            const originalLength = filteredData.length;
            filteredData = filteredData.filter(item => {
                const surveyId = item.survey_id?.toString();
                return investmentReportData.currentFilters.surveys.includes(surveyId);
            });
            console.log(`üîç Anket filtresi: ${originalLength} ‚Üí ${filteredData.length}`);
        }
        
        // Marka filtresi
        if (investmentReportData.currentFilters.brand.length > 0) {
            const originalLength = filteredData.length;
            console.log('üîç Marka filtresi uygulanƒ±yor:', investmentReportData.currentFilters.brand);
            filteredData = filteredData.filter(item => {
                const hasMatchingBrand = item.areas.some(area => 
                    investmentReportData.currentFilters.brand.includes(area.brand)
                );
                console.log(`üîç Item ${item.id} marka kontrol√º:`, item.areas.map(a => a.brand), '‚Üí', hasMatchingBrand);
                return hasMatchingBrand;
            });
            console.log(`üîç Marka filtresi: ${originalLength} ‚Üí ${filteredData.length}`);
        }
        
        // Alan Tipi filtresi
        if (investmentReportData.currentFilters.areaType) {
            const originalLength = filteredData.length;
            console.log('üîç Alan Tipi filtresi uygulanƒ±yor:', investmentReportData.currentFilters.areaType);
            filteredData = filteredData.filter(item => {
                const hasMatchingAreaType = item.areas.some(area => {
                    const areaType = area.area_type || area.areaType || 'wall'; // Default to wall if undefined
                    return areaType === investmentReportData.currentFilters.areaType;
                });
                console.log(`üîç Item ${item.id} alan tipi kontrol√º:`, item.areas.map(a => a.area_type || a.areaType), '‚Üí', hasMatchingAreaType);
                return hasMatchingAreaType;
            });
            console.log(`üîç Alan Tipi filtresi: ${originalLength} ‚Üí ${filteredData.length}`);
        }
        
        // B√∂lge filtresi
        if (investmentReportData.currentFilters.region) {
            const originalLength = filteredData.length;
            console.log('üîç B√∂lge filtresi uygulanƒ±yor:', investmentReportData.currentFilters.region);
            filteredData = filteredData.filter(item => {
                const storeId = item.store_id;
                const store = investmentReportData.stores.find(s => s.id === storeId);
                const isMatch = store && store.region_id == investmentReportData.currentFilters.region;
                console.log(`üîç Item ${item.id} b√∂lge kontrol√º: store ${storeId}, region ${store?.region_id}, match: ${isMatch}`);
                return isMatch;
            });
            console.log(`üîç B√∂lge filtresi: ${originalLength} ‚Üí ${filteredData.length}`);
        }
        
        // Kanal filtresi
        if (investmentReportData.currentFilters.channel) {
            const originalLength = filteredData.length;
            console.log('üîç Kanal filtresi uygulanƒ±yor:', investmentReportData.currentFilters.channel);
            filteredData = filteredData.filter(item => {
                const storeId = item.store_id;
                const store = investmentReportData.stores.find(s => s.id === storeId);
                const isMatch = store && store.channel_id == investmentReportData.currentFilters.channel;
                console.log(`üîç Item ${item.id} kanal kontrol√º: store ${storeId}, channel ${store?.channel_id}, match: ${isMatch}`);
                return isMatch;
            });
            console.log(`üîç Kanal filtresi: ${originalLength} ‚Üí ${filteredData.length}`);
        }
        
        // Maƒüaza filtresi
        if (investmentReportData.currentFilters.store) {
            const originalLength = filteredData.length;
            filteredData = filteredData.filter(item => {
                return item.store_id == investmentReportData.currentFilters.store;
            });
            console.log(`üîç Maƒüaza filtresi: ${originalLength} ‚Üí ${filteredData.length}`);
        }
        
        investmentReportData.filteredData = filteredData;
        console.log('‚úÖ', filteredData.length, 'filtreli kayƒ±t y√ºklendi');
        
    } catch (error) {
        console.error('‚ùå Filtreleme hatasƒ±:', error);
        investmentReportData.filteredData = [];
    }
}

// Grafikleri g√ºncelle
function updateCharts() {
    console.log('üìä Grafikler g√ºncelleniyor...');
    
    const data = investmentReportData.filteredData || [];
    console.log('üìä Grafikler i√ßin kullanƒ±lan veri:', data.length, 'kayƒ±t');
    
    // Filtrelerin uygulanƒ±p uygulanmadƒ±ƒüƒ±nƒ± kontrol et
    const hasActiveFilters = investmentReportData.currentFilters && (
        investmentReportData.currentFilters.surveys.length > 0 ||
        investmentReportData.currentFilters.brand.length > 0 ||
        investmentReportData.currentFilters.region ||
        investmentReportData.currentFilters.channel ||
        investmentReportData.currentFilters.store ||
        investmentReportData.currentFilters.areaType
    );
    
    console.log('üîç Aktif filtreler var mƒ±:', hasActiveFilters);
    console.log('üîç Current filters:', investmentReportData.currentFilters);
    console.log('üîç Data length:', data.length);
    console.log('üîç hasActiveFilters && data.length === 0:', hasActiveFilters && data.length === 0);
    
    // Eƒüer filtreler uygulanmƒ±≈üsa ve filtrelenmi≈ü veri yoksa, grafikleri bo≈ü g√∂ster
        if (hasActiveFilters && data.length === 0) {
            console.log('‚ö†Ô∏è Filtreler uygulanmƒ±≈ü ama veri yok, grafikleri bo≈ü g√∂steriliyor...');
            console.log('üîç showInvestmentNoDataCharts() √ßaƒürƒ±lƒ±yor...');
            showInvestmentNoDataCharts();
            console.log('üîç showInvestmentNoDataCharts() √ßaƒürƒ±sƒ± tamamlandƒ±');
            return;
        }
    
    // Eƒüer hi√ß veri yoksa, grafikleri bo≈ü g√∂ster
    if (data.length === 0) {
        console.log('‚ö†Ô∏è Hi√ß veri yok, grafikleri bo≈ü g√∂steriliyor...');
        showEmptyCharts();
        return;
    }
    
    // Alan tipi daƒüƒ±lƒ±mƒ± grafiƒüi
    updateAreaTypeChart(data);
    
    // Marka bazlƒ± yatƒ±rƒ±m analizi grafiƒüi
    updateBrandAnalysisChart(data);
    
    // Marka y√ºzdesel daƒüƒ±lƒ±mƒ± grafiƒüi
    updateInvestmentBrandPercentageChart(data);
    
    // Trend analizi grafiƒüi
    updateTrendAnalysisChart(data);
    
    console.log('‚úÖ Grafikler g√ºncellendi');
}

// Bo≈ü grafikleri g√∂ster
function showEmptyCharts() {
    try {
        console.log('üîç Bo≈ü grafikler g√∂steriliyor...');
        
        // √ñnceki Chart.js grafiklerini temizle
        if (window.areaTypeChart) {
            window.areaTypeChart.destroy();
            window.areaTypeChart = null;
        }
        if (window.brandAnalysisChart) {
            window.brandAnalysisChart.destroy();
            window.brandAnalysisChart = null;
        }
        if (window.brandPercentageChart) {
            window.brandPercentageChart.destroy();
            window.brandPercentageChart = null;
        }
        if (window.trendAnalysisChart) {
            window.trendAnalysisChart.destroy();
            window.trendAnalysisChart = null;
        }
        
        // Alan tipi daƒüƒ±lƒ±mƒ± grafiƒüi
        const areaTypeCanvas = document.getElementById('area-type-chart');
        if (areaTypeCanvas) {
            const ctx = areaTypeCanvas.getContext('2d');
            ctx.clearRect(0, 0, areaTypeCanvas.width, areaTypeCanvas.height);
            ctx.fillStyle = '#666';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Filtreleri uygulayƒ±n', areaTypeCanvas.width / 2, areaTypeCanvas.height / 2);
        }
        
        // Marka bazlƒ± yatƒ±rƒ±m analizi grafiƒüi
        const brandAnalysisCanvas = document.getElementById('brand-analysis-chart');
        if (brandAnalysisCanvas) {
            const ctx = brandAnalysisCanvas.getContext('2d');
            ctx.clearRect(0, 0, brandAnalysisCanvas.width, brandAnalysisCanvas.height);
            ctx.fillStyle = '#666';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Filtreleri uygulayƒ±n', brandAnalysisCanvas.width / 2, brandAnalysisCanvas.height / 2);
        }
        
        // Marka y√ºzdesel daƒüƒ±lƒ±mƒ± grafiƒüi
        const brandPercentageCanvas = document.getElementById('brand-percentage-chart');
        if (brandPercentageCanvas) {
            const ctx = brandPercentageCanvas.getContext('2d');
            ctx.clearRect(0, 0, brandPercentageCanvas.width, brandPercentageCanvas.height);
            ctx.fillStyle = '#666';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Filtreleri uygulayƒ±n', brandPercentageCanvas.width / 2, brandPercentageCanvas.height / 2);
        }
        
        // Trend analizi grafiƒüi
        const trendAnalysisCanvas = document.getElementById('trend-analysis-chart');
        if (trendAnalysisCanvas) {
            const ctx = trendAnalysisCanvas.getContext('2d');
            ctx.clearRect(0, 0, trendAnalysisCanvas.width, trendAnalysisCanvas.height);
            ctx.fillStyle = '#666';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Filtreleri uygulayƒ±n', trendAnalysisCanvas.width / 2, trendAnalysisCanvas.height / 2);
        }
        
        console.log('‚úÖ Bo≈ü grafikler g√∂sterildi');
        
    } catch (error) {
        console.error('‚ùå Bo≈ü grafikler g√∂sterme hatasƒ±:', error);
    }
}

// Veri bulunamadƒ± grafiklerini g√∂ster
function showInvestmentNoDataCharts() {
    console.log('üîç showInvestmentNoDataCharts fonksiyonu ba≈üladƒ±');
    
    try {
        console.log('üîç Veri bulunamadƒ± grafikleri g√∂steriliyor...');
        
        // √ñnceki Chart.js grafiklerini temizle
        if (window.areaTypeChart) {
            console.log('üîç areaTypeChart temizleniyor...');
            window.areaTypeChart.destroy();
            window.areaTypeChart = null;
        }
        if (window.brandAnalysisChart) {
            console.log('üîç brandAnalysisChart temizleniyor...');
            window.brandAnalysisChart.destroy();
            window.brandAnalysisChart = null;
        }
        if (window.brandPercentageChart) {
            console.log('üîç brandPercentageChart temizleniyor...');
            window.brandPercentageChart.destroy();
            window.brandPercentageChart = null;
        }
        if (window.trendAnalysisChart) {
            console.log('üîç trendAnalysisChart temizleniyor...');
            window.trendAnalysisChart.destroy();
            window.trendAnalysisChart = null;
        }
        
        console.log('üîç Canvas mesajlarƒ± yazƒ±lƒ±yor...');
        
        // T√ºm canvas'lara mesaj yaz
        const canvasIds = ['area-type-chart', 'brand-analysis-chart', 'brand-percentage-chart', 'trend-analysis-chart'];
        
        canvasIds.forEach(canvasId => {
            const canvas = document.getElementById(canvasId);
            console.log(`üîç ${canvasId} canvas:`, canvas);
            
            if (canvas) {
                console.log(`üîç ${canvasId} canvas bulundu`);
                
                // Canvas boyutlarƒ±nƒ± kontrol et
                console.log(`üîç ${canvasId} Canvas boyutlarƒ±:`, canvas.width, 'x', canvas.height);
                
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Mesajƒ± yaz
                ctx.fillStyle = '#e74c3c';
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('üìä Veri Bulunamadƒ±', canvas.width / 2, canvas.height / 2 - 10);
                
                ctx.fillStyle = '#7f8c8d';
                ctx.font = '14px Arial';
                ctx.fillText('Se√ßilen filtreler i√ßin', canvas.width / 2, canvas.height / 2 + 15);
                ctx.fillText('yatƒ±rƒ±m verisi mevcut deƒüil', canvas.width / 2, canvas.height / 2 + 35);
                
                console.log(`‚úÖ ${canvasId} mesajƒ± yazƒ±ldƒ±`);
            } else {
                console.error(`‚ùå ${canvasId} canvas bulunamadƒ±`);
            }
        });
        
        console.log('‚úÖ Veri bulunamadƒ± grafikleri g√∂sterildi');
        
    } catch (error) {
        console.error('‚ùå Veri bulunamadƒ± grafikleri g√∂sterme hatasƒ±:', error);
    }
    
    console.log('üîç showInvestmentNoDataCharts fonksiyonu bitti');
}

// Alan tipi etiket fonksiyonu
function getAreaTypeLabel(type) {
    const labels = {
        'wall': 'Duvar Standƒ±',
        'middle': 'Orta Alan Standƒ±',
        'desk': 'Masa √úst√º Standƒ±',
        'other': 'Diƒüer'
    };
    return labels[type] || type;
}

// Alan tipi daƒüƒ±lƒ±mƒ± grafiƒüi
function updateAreaTypeChart(data) {
    const canvas = document.getElementById('area-type-chart');
    if (!canvas) {
        console.error('‚ùå area-type-chart canvas bulunamadƒ±');
        return;
    }
    
    // √ñnceki grafiƒüi temizle
    if (window.areaTypeChart) {
        window.areaTypeChart.destroy();
    }
    
    const areaTypeCounts = {};
    data.forEach(item => {
        item.areas.forEach(area => {
            const areaType = area.area_type || 'middle';
            areaTypeCounts[areaType] = (areaTypeCounts[areaType] || 0) + 1;
        });
    });
    
    const labels = Object.keys(areaTypeCounts).map(type => getAreaTypeLabel(type));
    const values = Object.values(areaTypeCounts);
    
    window.areaTypeChart = new Chart(canvas, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Alan Tipi Daƒüƒ±lƒ±mƒ±'
                },
                legend: {
                    position: 'bottom'
                }
            },
            onClick: (event, elements) => {
                console.log('üîç Chart.js onClick tetiklendi:', { event, elements });
                
                // Eƒüer grafik elemanƒ±na tƒ±klandƒ±ysa
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const label = labels[index];
                    const value = values[index];
                    showChartModal('area-type-chart', 'Alan Tipi Daƒüƒ±lƒ±mƒ±', { labels, values });
                } else {
                    // Eƒüer bo≈ü alana tƒ±klandƒ±ysa (ba≈ülƒ±k alanƒ± olabilir)
                    const rect = event.native.target.getBoundingClientRect();
                    const y = event.native.offsetY;
                    console.log('üîç Bo≈ü alana tƒ±klandƒ±, pozisyon:', { y, rect });
                    
                    if (y < 50) {
                        console.log('üîç Ba≈ülƒ±k alanƒ±na tƒ±klandƒ± (Chart.js onClick)');
                        showChartModal('area-type-chart', 'Alan Tipi Daƒüƒ±lƒ±mƒ±', { labels, values });
                    }
                }
            }
        }
    });
    
    // Canvas'a ba≈ülƒ±k tƒ±klama event'i ekle
    canvas.addEventListener('click', function(event) {
        console.log('üîç Canvas click event tetiklendi:', event);
        const rect = canvas.getBoundingClientRect();
        const y = event.clientY - rect.top;
        
        console.log('üîç Click pozisyonu:', { y, rect });
        
        // Ba≈ülƒ±k alanƒ± yakla≈üƒ±k olarak √ºst 50px'de
        if (y < 50) {
            console.log('üîç Ba≈ülƒ±k alanƒ±na tƒ±klandƒ±, modal a√ßƒ±lƒ±yor...');
            console.log('üîç showChartModal fonksiyonu var mƒ±?', typeof showChartModal);
            if (typeof showChartModal === 'function') {
                showChartModal('area-type-chart', 'Alan Tipi Daƒüƒ±lƒ±mƒ±', { labels, values });
            } else {
                console.error('‚ùå showChartModal fonksiyonu tanƒ±mlƒ± deƒüil!');
            }
        }
    });
    
    // Canvas'a hover event'i ekle
    canvas.addEventListener('mousemove', function(event) {
        const rect = canvas.getBoundingClientRect();
        const y = event.clientY - rect.top;
        
        // Ba≈ülƒ±k alanƒ± yakla≈üƒ±k olarak √ºst 50px'de
        if (y < 50) {
            canvas.style.cursor = 'pointer';
        } else {
            canvas.style.cursor = 'default';
        }
    });
}

// Marka bazlƒ± yatƒ±rƒ±m analizi grafiƒüi
function updateBrandAnalysisChart(data) {
    const canvas = document.getElementById('brand-analysis-chart');
    if (!canvas) {
        console.error('‚ùå brand-analysis-chart canvas bulunamadƒ±');
        return;
    }
    
    if (window.brandAnalysisChart) {
        window.brandAnalysisChart.destroy();
    }
    
    const brandCounts = {};
    data.forEach(item => {
        item.areas.forEach(area => {
            const brand = area.brand;
            if (!brandCounts[brand]) {
                brandCounts[brand] = { wall: 0, middle: 0, total: 0 };
            }
            const areaType = area.area_type || 'middle';
            brandCounts[brand][areaType]++;
            brandCounts[brand].total++;
        });
    });
    
    const brands = Object.keys(brandCounts);
    const wallData = brands.map(brand => brandCounts[brand].wall);
    const middleData = brands.map(brand => brandCounts[brand].middle);
    
    window.brandAnalysisChart = new Chart(canvas, {
        type: 'bar',
        data: {
            labels: brands,
            datasets: [
                {
                    label: 'Duvar',
                    data: wallData,
                    backgroundColor: '#FF6384'
                },
                {
                    label: 'Orta Alan',
                    data: middleData,
                    backgroundColor: '#36A2EB'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Marka Bazlƒ± Yatƒ±rƒ±m Analizi'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            onClick: (event, elements) => {
                console.log('üîç Brand Analysis Chart.js onClick tetiklendi:', { event, elements });
                
                // Eƒüer grafik elemanƒ±na tƒ±klandƒ±ysa
                if (elements.length > 0) {
                    showChartModal('brand-analysis-chart', 'Marka Bazlƒ± Yatƒ±rƒ±m Analizi', { brands, wallData, middleData });
                } else {
                    // Eƒüer bo≈ü alana tƒ±klandƒ±ysa (ba≈ülƒ±k alanƒ± olabilir)
                    const rect = event.native.target.getBoundingClientRect();
                    const y = event.native.offsetY;
                    console.log('üîç Brand Analysis bo≈ü alana tƒ±klandƒ±, pozisyon:', { y, rect });
                    
                    if (y < 50) {
                        console.log('üîç Brand Analysis ba≈ülƒ±k alanƒ±na tƒ±klandƒ± (Chart.js onClick)');
                        showChartModal('brand-analysis-chart', 'Marka Bazlƒ± Yatƒ±rƒ±m Analizi', { brands, wallData, middleData });
                    }
                }
            }
        }
    });
    
    // Canvas'a ba≈ülƒ±k tƒ±klama event'i ekle
    canvas.addEventListener('click', function(event) {
        console.log('üîç Brand Analysis Canvas click event tetiklendi:', event);
        const rect = canvas.getBoundingClientRect();
        const y = event.clientY - rect.top;
        
        console.log('üîç Brand Analysis Click pozisyonu:', { y, rect });
        
        // Ba≈ülƒ±k alanƒ± yakla≈üƒ±k olarak √ºst 50px'de
        if (y < 50) {
            console.log('üîç Brand Analysis ba≈ülƒ±k alanƒ±na tƒ±klandƒ±, modal a√ßƒ±lƒ±yor...');
            console.log('üîç Brand Analysis showChartModal fonksiyonu var mƒ±?', typeof showChartModal);
            console.log('üîç showChartModal tipi:', typeof showChartModal);
            console.log('üîç showChartModal deƒüeri:', showChartModal);
            if (typeof showChartModal === 'function') {
                console.log('‚úÖ showChartModal fonksiyonu tespit edildi, √ßaƒürƒ±lƒ±yor...');
                console.log('üîç √áaƒürƒ± parametreleri:', { 
                    chartId: 'brand-analysis-chart', 
                    title: 'Marka Bazlƒ± Yatƒ±rƒ±m Analizi', 
                    data: { brands, wallData, middleData } 
                });
                console.log('üîç showChartModal √ßaƒürƒ±lmadan √∂nce...');
                try {
                    showChartModal('brand-analysis-chart', 'Marka Bazlƒ± Yatƒ±rƒ±m Analizi', { brands, wallData, middleData });
                    console.log('‚úÖ showChartModal √ßaƒürƒ±sƒ± tamamlandƒ±');
                } catch (error) {
                    console.error('‚ùå showChartModal √ßaƒürƒ±sƒ± ba≈üarƒ±sƒ±z:', error);
                    alert('Modal a√ßma hatasƒ±: ' + error.message);
                }
            } else {
                console.error('‚ùå Brand Analysis showChartModal fonksiyonu tanƒ±mlƒ± deƒüil!');
                console.error('‚ùå Type:', typeof showChartModal);
                console.error('‚ùå Deƒüer:', showChartModal);
            }
        }
    });
    
    // Canvas'a hover event'i ekle
    canvas.addEventListener('mousemove', function(event) {
        const rect = canvas.getBoundingClientRect();
        const y = event.clientY - rect.top;
        
        // Ba≈ülƒ±k alanƒ± yakla≈üƒ±k olarak √ºst 50px'de
        if (y < 50) {
            canvas.style.cursor = 'pointer';
        } else {
            canvas.style.cursor = 'default';
        }
    });
}

// Marka y√ºzdesel daƒüƒ±lƒ±mƒ± grafiƒüi
function updateInvestmentBrandPercentageChart(data) {
    console.log('üîç Marka y√ºzdesel daƒüƒ±lƒ±m grafiƒüi g√ºncelleniyor...');
    console.log('üîç Gelen veri:', data.length, 'kayƒ±t');
    
    const canvas = document.getElementById('brand-percentage-chart');
    if (!canvas) {
        console.error('‚ùå brand-percentage-chart canvas bulunamadƒ±');
        return;
    }
    
    if (window.brandPercentageChart) {
        window.brandPercentageChart.destroy();
    }
    
    const brandCounts = {};
    data.forEach((item, index) => {
        console.log(`üîç Item ${index}:`, item);
        console.log(`üîç Item ${index} t√ºm alanlar:`, Object.keys(item));
        
        // Veri yapƒ±sƒ±nƒ± kontrol et - areas field'ƒ± var mƒ±?
        if (item.areas && Array.isArray(item.areas)) {
            console.log(`üîç Item ${index} areas bulundu:`, item.areas);
            item.areas.forEach((area, areaIndex) => {
                console.log(`üîç Area ${areaIndex}:`, area);
                if (typeof area === 'string') {
                    // Eƒüer area string ise, direkt marka olarak kullan
                    brandCounts[area] = (brandCounts[area] || 0) + 1;
                } else if (area && typeof area === 'object') {
                    // Eƒüer area object ise, brand field'ƒ±nƒ± kullan
                    if (area.brand) {
                        brandCounts[area.brand] = (brandCounts[area.brand] || 0) + 1;
                    }
                }
            });
        } else {
            console.warn(`‚ö†Ô∏è Item ${index} areas bulunamadƒ± veya array deƒüil:`, item.areas);
            console.log(`üîç Item ${index} mevcut alanlar:`, Object.keys(item));
        }
    });
    
    console.log('üîç Brand counts:', brandCounts);
    
    const total = Object.values(brandCounts).reduce((sum, count) => sum + count, 0);
    console.log('üîç Total:', total);
    
    if (total === 0) {
        console.warn('‚ö†Ô∏è Hi√ß marka verisi bulunamadƒ±!');
        // Bo≈ü grafik g√∂ster
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#666';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Marka verisi bulunamadƒ±', canvas.width / 2, canvas.height / 2);
        return;
    }
    
    const labels = Object.keys(brandCounts).map(brand => {
        const count = brandCounts[brand];
        const percentage = ((count / total) * 100).toFixed(1);
        return `${brand} (${percentage}%)`;
    });
    const values = Object.values(brandCounts);
    
    console.log('üîç Labels:', labels);
    console.log('üîç Values:', values);
    
    window.brandPercentageChart = new Chart(canvas, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: `Marka Y√ºzdesel Daƒüƒ±lƒ±mƒ± (Toplam: ${total} Yatƒ±rƒ±m Alanƒ±)`
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return {
                                        text: `${label} (${value} alan)`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: data.datasets[0].backgroundColor[i],
                                        lineWidth: 1,
                                        hidden: false,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label.replace(/ \(\d+\.\d+%\)$/, ''); // Y√ºzde kƒ±smƒ±nƒ± √ßƒ±kar
                            const value = context.parsed;
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} yatƒ±rƒ±m alanƒ± (${percentage}%)`;
                        }
                    }
                }
            },
            onClick: (event, elements) => {
                console.log('üîç Brand Percentage Chart.js onClick tetiklendi:', { event, elements });
                
                // Eƒüer grafik elemanƒ±na tƒ±klandƒ±ysa
                if (elements.length > 0) {
                    showChartModal('brand-percentage-chart', 'Marka Y√ºzdesel Daƒüƒ±lƒ±mƒ±', { labels, values });
                } else {
                    // Eƒüer bo≈ü alana tƒ±klandƒ±ysa (ba≈ülƒ±k alanƒ± olabilir)
                    const rect = event.native.target.getBoundingClientRect();
                    const y = event.native.offsetY;
                    console.log('üîç Brand Percentage bo≈ü alana tƒ±klandƒ±, pozisyon:', { y, rect });
                    
                    if (y < 50) {
                        console.log('üîç Brand Percentage ba≈ülƒ±k alanƒ±na tƒ±klandƒ± (Chart.js onClick)');
                        showChartModal('brand-percentage-chart', `Marka Y√ºzdesel Daƒüƒ±lƒ±mƒ± (Toplam: ${total} Yatƒ±rƒ±m Alanƒ±)`, { labels, values });
                    }
                }
            }
        }
    });
    
    // Canvas'a ba≈ülƒ±k tƒ±klama event'i ekle
    canvas.addEventListener('click', function(event) {
        console.log('üîç Brand Percentage Canvas click event tetiklendi:', event);
        const rect = canvas.getBoundingClientRect();
        const y = event.clientY - rect.top;
        
        console.log('üîç Brand Percentage Click pozisyonu:', { y, rect });
        
        // Ba≈ülƒ±k alanƒ± yakla≈üƒ±k olarak √ºst 50px'de
        if (y < 50) {
            console.log('üîç Brand Percentage ba≈ülƒ±k alanƒ±na tƒ±klandƒ±, modal a√ßƒ±lƒ±yor...');
            console.log('üîç Brand Percentage showChartModal fonksiyonu var mƒ±?', typeof showChartModal);
            if (typeof showChartModal === 'function') {
                showChartModal('brand-percentage-chart', `Marka Y√ºzdesel Daƒüƒ±lƒ±mƒ± (Toplam: ${total} Yatƒ±rƒ±m Alanƒ±)`, { labels, values });
            } else {
                console.error('‚ùå Brand Percentage showChartModal fonksiyonu tanƒ±mlƒ± deƒüil!');
            }
        }
    });
    
    // Canvas'a hover event'i ekle
    canvas.addEventListener('mousemove', function(event) {
        const rect = canvas.getBoundingClientRect();
        const y = event.clientY - rect.top;
        
        // Ba≈ülƒ±k alanƒ± yakla≈üƒ±k olarak √ºst 50px'de
        if (y < 50) {
            canvas.style.cursor = 'pointer';
        } else {
            canvas.style.cursor = 'default';
        }
    });
    
    console.log('‚úÖ Marka y√ºzdesel daƒüƒ±lƒ±m grafiƒüi olu≈üturuldu');
}

// Trend analizi grafiƒüi
function updateTrendAnalysisChart(data) {
    const canvas = document.getElementById('trend-analysis-chart');
    if (!canvas) {
        console.error('‚ùå trend-analysis-chart canvas bulunamadƒ±');
        return;
    }
    
    if (window.trendAnalysisChart) {
        window.trendAnalysisChart.destroy();
    }
    
    // Survey bazlƒ± analiz
    const surveyData = {};
    data.forEach(item => {
        const surveyId = item.survey_id;
        if (!surveyData[surveyId]) {
            surveyData[surveyId] = {};
        }
        item.areas.forEach(area => {
            const brand = area.brand;
            surveyData[surveyId][brand] = (surveyData[surveyId][brand] || 0) + 1;
        });
    });
    
    const surveys = Object.keys(surveyData);
    if (surveys.length < 2) {
        console.log('‚ö†Ô∏è Trend analizi i√ßin en az 2 anket gerekli');
        return;
    }
    
    const brands = [...new Set(data.flatMap(item => item.areas.map(area => area.brand)))];
    const datasets = brands.map((brand, index) => ({
        label: brand,
        data: surveys.map(surveyId => surveyData[surveyId][brand] || 0),
        borderColor: `hsl(${index * 60}, 70%, 50%)`,
        backgroundColor: `hsla(${index * 60}, 70%, 50%, 0.1)`,
        fill: false
    }));
    
    const surveyNames = {};
    surveys.forEach(surveyId => {
        const survey = investmentReportData.surveys.find(s => s.id == surveyId);
        surveyNames[surveyId] = survey ? survey.title : `Anket ${surveyId}`;
    });
    
    window.trendAnalysisChart = new Chart(canvas, {
        type: 'line',
        data: {
            labels: surveys.map(id => surveyNames[id]),
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Marka Stand Sayƒ±sƒ± Trend Analizi'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            onClick: (event, elements) => {
                console.log('üîç Trend Analysis Chart.js onClick tetiklendi:', { event, elements });
                
                // Eƒüer grafik elemanƒ±na tƒ±klandƒ±ysa
                if (elements.length > 0) {
                    showChartModal('trend-analysis-chart', 'Trend Analizi', { surveys, brands, surveyData });
                } else {
                    // Eƒüer bo≈ü alana tƒ±klandƒ±ysa (ba≈ülƒ±k alanƒ± olabilir)
                    const rect = event.native.target.getBoundingClientRect();
                    const y = event.native.offsetY;
                    console.log('üîç Trend Analysis bo≈ü alana tƒ±klandƒ±, pozisyon:', { y, rect });
                    
                    if (y < 50) {
                        console.log('üîç Trend Analysis ba≈ülƒ±k alanƒ±na tƒ±klandƒ± (Chart.js onClick)');
                        showChartModal('trend-analysis-chart', 'Trend Analizi', { surveys, brands, surveyData });
                    }
                }
            }
        }
    });
    
    // Canvas'a ba≈ülƒ±k tƒ±klama event'i ekle
    canvas.addEventListener('click', function(event) {
        console.log('üîç Trend Analysis Canvas click event tetiklendi:', event);
        const rect = canvas.getBoundingClientRect();
        const y = event.clientY - rect.top;
        
        console.log('üîç Trend Analysis Click pozisyonu:', { y, rect });
        
        // Ba≈ülƒ±k alanƒ± yakla≈üƒ±k olarak √ºst 50px'de
        if (y < 50) {
            console.log('üîç Trend Analysis ba≈ülƒ±k alanƒ±na tƒ±klandƒ±, modal a√ßƒ±lƒ±yor...');
            console.log('üîç Trend Analysis showChartModal fonksiyonu var mƒ±?', typeof showChartModal);
            if (typeof showChartModal === 'function') {
                showChartModal('trend-analysis-chart', 'Trend Analizi', { surveys, brands, surveyData });
            } else {
                console.error('‚ùå Trend Analysis showChartModal fonksiyonu tanƒ±mlƒ± deƒüil!');
            }
        }
    });
    
    // Canvas'a hover event'i ekle
    canvas.addEventListener('mousemove', function(event) {
        const rect = canvas.getBoundingClientRect();
        const y = event.clientY - rect.top;
        
        // Ba≈ülƒ±k alanƒ± yakla≈üƒ±k olarak √ºst 50px'de
        if (y < 50) {
            canvas.style.cursor = 'pointer';
        } else {
            canvas.style.cursor = 'default';
        }
    });
}

// Grafik modalƒ±nƒ± g√∂ster
window.showChartModal = function(chartId, title, data) {
    try {
        console.log('üîç showChartModal √ßaƒürƒ±ldƒ±:', { chartId, title, data });
        console.log('üîç Console output ba≈üladƒ±');
        // Eski modalƒ± kaldƒ±r
        const existingModal = document.getElementById('chartModal');
        if (existingModal) {
            console.log('üîç Eski modal kaldƒ±rƒ±lƒ±yor...');
            existingModal.remove();
        }
        
        const modalHtml = `
            <div class="modal fade" id="chartModal" tabindex="-1" aria-labelledby="chartModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="chartModalLabel">${title}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div style="position: relative; height: 400px; width: 100%;">
                                <canvas id="modalChart"></canvas>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Yeni modalƒ± ekle
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        console.log('‚úÖ Modal HTML eklendi');
        
        const modalElement = document.getElementById('chartModal');
        console.log('‚úÖ Modal element bulundu:', modalElement);
        console.log('üîç Modal element var mƒ±?', !!modalElement);
        
        // Modalƒ± g√∂ster
        console.log('üîç Modal g√∂steriliyor...');
        modalElement.classList.add('show');
        modalElement.style.display = 'block';
        document.body.classList.add('modal-open');
        
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        backdrop.id = 'modalBackdrop';
        document.body.appendChild(backdrop);
        
        // Kapat butonlarƒ± i√ßin event listener
        let isClosing = false;
        const closeModal = () => {
            if (isClosing) return;
            isClosing = true;
            
            console.log('üîç Modal kapatƒ±lƒ±yor...');
            if (window.modalChart && typeof window.modalChart.destroy === 'function') {
                window.modalChart.destroy();
                window.modalChart = null;
            }
            modalElement.classList.remove('show');
            modalElement.style.display = 'none';
            document.body.classList.remove('modal-open');
            const backdropElement = document.getElementById('modalBackdrop');
            if (backdropElement) backdropElement.remove();
            
            setTimeout(() => {
                modalElement.remove();
                isClosing = false;
            }, 300);
        };
        
        modalElement.querySelectorAll('[data-bs-dismiss="modal"], .btn-secondary').forEach(btn => {
            btn.addEventListener('click', closeModal);
        });
        
        // Backdrop tƒ±klamasƒ±nda kapat
        backdrop.addEventListener('click', closeModal);
        
        // Grafik i√ßin biraz bekle
        setTimeout(() => {
            console.log('üîç Grafik olu≈üturuluyor...');
            createModalChart(chartId, title, data);
        }, 100);
        
        console.log('‚úÖ Modal g√∂sterildi');
    } catch (error) {
        console.error('‚ùå showChartModal hatasƒ±:', error);
        alert('Modal a√ßƒ±lƒ±rken hata olu≈ütu: ' + error.message);
    }
}

// Modal grafiƒüi olu≈ütur
window.createModalChart = function(chartId, title, data) {
    console.log('üîç createModalChart √ßaƒürƒ±ldƒ±:', { chartId, title, data });
    
    const canvas = document.getElementById('modalChart');
    if (!canvas) {
        console.error('‚ùå Modal canvas bulunamadƒ±');
        return;
    }
    
    console.log('‚úÖ Modal canvas bulundu:', canvas);
    console.log('‚úÖ Canvas boyutlarƒ±:', canvas.offsetWidth, 'x', canvas.offsetHeight);
    
    // √ñnceki grafiƒüi temizle
    if (window.modalChart && typeof window.modalChart.destroy === 'function') {
        console.log('üîç √ñnceki grafik temizleniyor...');
        window.modalChart.destroy();
        window.modalChart = null;
    }
    
    // Canvas'ƒ± temizle
    const ctx = canvas.getContext('2d');
    if (ctx) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    
    let chartConfig;
    
    switch (chartId) {
        case 'area-type-chart':
            chartConfig = {
                type: 'doughnut',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.values,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { 
                            display: true, 
                            text: title,
                            font: { size: 20 }
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            };
            break;
            
        case 'brand-analysis-chart':
            chartConfig = {
                type: 'bar',
                data: {
                    labels: data.brands,
                    datasets: [
                        { label: 'Duvar', data: data.wallData, backgroundColor: '#FF6384' },
                        { label: 'Orta Alan', data: data.middleData, backgroundColor: '#36A2EB' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        title: { 
                            display: true, 
                            text: title,
                            font: { size: 20 }
                        },
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Stand Sayƒ±sƒ±'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Markalar'
                            }
                        }
                    }
                }
            };
            break;
            
        case 'brand-percentage-chart':
            chartConfig = {
                type: 'pie',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.values,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#FF6384']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        title: { 
                            display: true, 
                            text: title,
                            font: { size: 20 }
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            };
            break;
            
        case 'trend-analysis-chart':
            const datasets = data.brands.map((brand, index) => ({
                label: brand,
                data: data.surveys.map(surveyId => data.surveyData[surveyId] ? data.surveyData[surveyId][brand] || 0 : 0),
                borderColor: `hsl(${index * 60}, 70%, 50%)`,
                backgroundColor: `hsla(${index * 60}, 70%, 50%, 0.1)`,
                fill: false
            }));
            
            chartConfig = {
                type: 'line',
                data: {
                    labels: data.surveys.map(id => `Anket ${id}`),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        title: { 
                            display: true, 
                            text: title,
                            font: { size: 20 }
                        },
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Stand Sayƒ±sƒ±'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Anket D√∂nemleri'
                            }
                        }
                    }
                }
            };
            break;
    }
    
    console.log('üîç Chart config:', chartConfig);
    
    if (chartConfig) {
        console.log('‚úÖ Chart olu≈üturuluyor...');
        try {
            window.modalChart = new Chart(canvas, chartConfig);
            console.log('‚úÖ Chart ba≈üarƒ±yla olu≈üturuldu:', window.modalChart);
            console.log('üîç Chart data:', window.modalChart.data);
            console.log('üîç Chart options:', window.modalChart.options);
        } catch (error) {
            console.error('‚ùå Chart olu≈üturma hatasƒ±:', error);
            // Hata durumunda modal i√ßine hata mesajƒ± g√∂ster
            const ctx = canvas.getContext('2d');
            ctx.font = '16px Arial';
            ctx.fillStyle = '#e74c3c';
            ctx.textAlign = 'center';
            ctx.fillText('Grafik olu≈üturulamadƒ±', canvas.width / 2, canvas.height / 2);
        }
    } else {
        console.error('‚ùå Chart config bulunamadƒ±!');
        console.error('üîç Gelen veri:', { chartId, title, data });
    }
}

// Maƒüaza tablosunu g√ºncelle
function updateStoreTable() {
    console.log('üìä Maƒüaza tablosu g√ºncelleniyor...');
    
    const tbody = document.getElementById('investment-store-tbody');
    if (!tbody) {
        console.error('‚ùå investment-store-tbody bulunamadƒ±');
        return;
    }
    
    const data = investmentReportData.filteredData || [];
    const searchTerm = document.getElementById('investment-store-search')?.value.toLowerCase() || '';
    
    console.log('üìä Tablo i√ßin veri:', data.length, 'kayƒ±t, arama:', searchTerm);
    
    // Arama filtresi uygula
    let filteredData = data;
    if (searchTerm) {
        filteredData = data.filter(item => {
            const storeId = item.store_id;
            const store = investmentReportData.stores.find(s => s.id === storeId);
            const storeName = store ? store.name.toLowerCase() : '';
            
            const brandMatches = item.areas.some(area => 
                area.brand.toLowerCase().includes(searchTerm)
            );
            
            const survey = investmentReportData.surveys.find(s => s.id === item.survey_id);
            const surveyName = survey ? survey.title.toLowerCase() : '';
            
            return storeName.includes(searchTerm) || brandMatches || surveyName.includes(searchTerm);
        });
    }
    
    console.log('üìä Arama sonrasƒ±:', filteredData.length, 'kayƒ±t');
    
    tbody.innerHTML = '';
    
    if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center">Veri bulunamadƒ±</td></tr>';
        return;
    }
    
    filteredData.forEach(item => {
        const storeId = item.store_id;
        const store = investmentReportData.stores.find(s => s.id === storeId);
        const storeName = store ? store.name : 'Bilinmeyen Maƒüaza';
        
        const region = store ? investmentReportData.regions.find(r => r.id === store.region_id) : null;
        const regionName = region ? region.name : '-';
        
        const channel = store ? investmentReportData.channels.find(c => c.id === store.channel_id) : null;
        const channelName = channel ? channel.name : '-';
        
        const survey = investmentReportData.surveys.find(s => s.id === item.survey_id);
        const surveyName = survey ? survey.title : 'Bilinmeyen Anket';
        
        // Marka filtresi varsa sadece o markalarƒ± g√∂ster
        const areasToShow = investmentReportData.currentFilters.brand.length > 0 
            ? item.areas.filter(area => investmentReportData.currentFilters.brand.includes(area.brand))
            : item.areas;
        
        console.log(`üîç Item ${item.id} i√ßin g√∂sterilecek area'lar:`, areasToShow.map(a => a.brand));
        
        areasToShow.forEach(area => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${storeName}</td>
                <td>${regionName}</td>
                <td>${channelName}</td>
                <td>${surveyName}</td>
                <td>${area.brand}</td>
                                                <td>${getAreaTypeLabel(area.area_type || 'middle')}</td>
                <td>${area.photos_count}</td>
                <td>${new Date().toLocaleDateString('tr-TR')}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="viewPhotos(${item.id}, '${area.brand}', '${area.area_type || 'middle'}', '${storeName}')">
                        Fotoƒüraflar
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    });
    
    console.log('‚úÖ Maƒüaza tablosu g√ºncellendi:', filteredData.length, 'kayƒ±t');
}

// Fotoƒüraflarƒ± g√∂r√ºnt√ºle
function viewPhotos(itemId, brand, areaType, storeName) {
    console.log('üì∏ Fotoƒüraflar g√∂r√ºnt√ºleniyor:', { itemId, brand, areaType, storeName });
    
    const item = investmentReportData.areasAnalysis.find(i => i.id === itemId);
    if (!item) {
        showAlert('Veri bulunamadƒ±', 'error');
        return;
    }
    
    const area = item.areas.find(a => a.brand === brand && a.area_type === areaType);
    if (!area || !area.photos || area.photos.length === 0) {
        showAlert('Bu alan i√ßin fotoƒüraf bulunamadƒ±', 'warning');
        return;
    }
    
    const normalizedAreaType = getAreaTypeLabel(areaType);
    
    const modalHtml = `
        <div class="modal fade" id="photosModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${storeName} - ${brand} (${normalizedAreaType})</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            ${area.photos.map((photo, index) => `
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <img src="${photo}" class="card-img-top" style="height: 200px; object-fit: cover;" 
                                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkZvdG9ncmFmIEJ1bHVuYW1hZGl8L3RleHQ+PC9zdmc+'">
                                        <div class="card-body p-2">
                                            <button class="btn btn-sm btn-primary w-100" onclick="window.open('${photo}', '_blank')">
                                                Tam Boyut
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Eski modalƒ± kaldƒ±r
    const existingModal = document.getElementById('photosModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Yeni modalƒ± ekle
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Modalƒ± g√∂ster
    const modal = new bootstrap.Modal(document.getElementById('photosModal'));
    modal.show();
}

// Alert g√∂ster
function showAlert(message, type = 'info') {
    const alertHtml = `
        <div class="alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Alert container'ƒ± bul veya olu≈ütur
    let alertContainer = document.getElementById('alert-container');
    if (!alertContainer) {
        alertContainer = document.createElement('div');
        alertContainer.id = 'alert-container';
        alertContainer.style.position = 'fixed';
        alertContainer.style.top = '20px';
        alertContainer.style.right = '20px';
        alertContainer.style.zIndex = '9999';
        document.body.appendChild(alertContainer);
    }
    
    alertContainer.insertAdjacentHTML('beforeend', alertHtml);
    
    // 5 saniye sonra otomatik kapat
    setTimeout(() => {
        const alert = alertContainer.lastElementChild;
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 5000);
}

// Sunum sistemi
let presentationData = {
    slides: [],
    currentSlide: 0,
    totalSlides: 0
};

// Sunum olu≈ütur
function createPresentation() {
    console.log('üé¨ Sunum olu≈üturuluyor...');
    
    const data = investmentReportData.filteredData || [];
    if (data.length === 0) {
        showAlert('Sunum i√ßin veri bulunamadƒ±. L√ºtfen filtreleri kontrol edin.', 'warning');
        return;
    }
    
    // Veriyi marka bazƒ±nda grupla
    const brandGroups = {};
    data.forEach(item => {
        const storeId = item.store_id;
        const store = investmentReportData.stores.find(s => s.id === storeId);
        const storeName = store ? store.name : 'Bilinmeyen Maƒüaza';
        
        const region = store ? investmentReportData.regions.find(r => r.id === store.region_id) : null;
        const regionName = region ? region.name : '-';
        
        const channel = store ? investmentReportData.channels.find(c => c.id === store.channel_id) : null;
        const channelName = channel ? channel.name : '-';
        
        const survey = investmentReportData.surveys.find(s => s.id === item.survey_id);
        const surveyName = survey ? survey.title : 'Bilinmeyen Anket';
        
        item.areas.forEach(area => {
            if (!brandGroups[area.brand]) {
                brandGroups[area.brand] = [];
            }
            
            brandGroups[area.brand].push({
                storeId: storeId,
                storeName: storeName,
                regionName: regionName,
                channelName: channelName,
                surveyName: surveyName,
                brand: area.brand,
                areaType: area.area_type || 'middle',
                photos: area.photos || [],
                photosCount: area.photos_count || 0
            });
        });
    });
    
    console.log('üìä Marka gruplarƒ±:', Object.keys(brandGroups));
    
    // Markalarƒ± alfabetik sƒ±rala
    const sortedBrands = Object.keys(brandGroups).sort();
    console.log('üìä Alfabetik markalar:', sortedBrands);
    
    // Her marka i√ßin slaytlar olu≈ütur
    presentationData.slides = [];
    sortedBrands.forEach(brand => {
        const stores = brandGroups[brand];
        
        // Maƒüazalarƒ± 3'l√º gruplara b√∂l
        for (let i = 0; i < stores.length; i += 3) {
            const slideStores = stores.slice(i, i + 3);
            presentationData.slides.push({
                brand: brand,
                stores: slideStores,
                slideNumber: presentationData.slides.length + 1
            });
        }
    });
    
    presentationData.totalSlides = presentationData.slides.length;
    presentationData.currentSlide = 0;
    
    console.log('‚úÖ Sunum hazƒ±rlandƒ±:', presentationData.totalSlides, 'slayt');
    
    // Modalƒ± g√∂ster
    showPresentationModal();
}

// Sunum modalƒ±nƒ± g√∂ster
function showPresentationModal() {
    const modal = new bootstrap.Modal(document.getElementById('presentationModal'));
    modal.show();
    
    // Sunum i√ßeriƒüini olu≈ütur
    generatePresentationSlides();
    
    // ƒ∞lk slaytƒ± g√∂ster
    showSlide(0);
    
    // Event listener'larƒ± kur
    setupPresentationEventListeners();
}

// Sunum slaytlarƒ±nƒ± olu≈ütur
function generatePresentationSlides() {
    const container = document.getElementById('presentation-container');
    container.innerHTML = '';
    
    presentationData.slides.forEach((slide, index) => {
        const slideElement = document.createElement('div');
        slideElement.className = 'presentation-slide';
        slideElement.id = `slide-${index}`;
        
        slideElement.innerHTML = `
            <div class="slide-header">
                <h1 class="slide-title">${slide.brand}</h1>
                <p class="slide-subtitle">Marka Yatƒ±rƒ±m Alanlarƒ±</p>
            </div>
            
            <div class="stores-grid">
                ${slide.stores.map(store => `
                    <div class="store-card">
                        <div class="store-name">${store.storeName}</div>
                        <div class="brand-badge">${store.brand}</div>
                        <div class="photos-grid">
                            ${store.photos.slice(0, 4).map((photo, photoIndex) => `
                                <div class="photo-item">
                                    <img src="${photo}" alt="${store.storeName} - ${store.brand}" 
                                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkZvdG9ncmFmIEJ1bHVuYW1hZGl8L3RleHQ+PC9zdmc+'">
                                    ${photoIndex === 3 && store.photos.length > 4 ? `<div class="photo-count">+${store.photos.length - 4}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                        <div class="mt-2">
                            <small>${store.regionName} - ${store.channelName}</small>
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <div class="slide-dots">
                ${presentationData.slides.map((_, dotIndex) => `
                    <div class="slide-dot ${dotIndex === index ? 'active' : ''}" onclick="showSlide(${dotIndex})"></div>
                `).join('')}
            </div>
        `;
        
        container.appendChild(slideElement);
    });
}

// Slayt g√∂ster
function showSlide(slideIndex) {
    // T√ºm slaytlarƒ± gizle
    document.querySelectorAll('.presentation-slide').forEach(slide => {
        slide.classList.remove('active');
    });
    
    // Se√ßili slaytƒ± g√∂ster
    const targetSlide = document.getElementById(`slide-${slideIndex}`);
    if (targetSlide) {
        targetSlide.classList.add('active');
    }
    
    // Slayt sayacƒ±nƒ± g√ºncelle
    document.getElementById('slide-counter').textContent = `${slideIndex + 1} / ${presentationData.totalSlides}`;
    
    // Butonlarƒ± g√ºncelle
    document.getElementById('prev-slide-btn').disabled = slideIndex === 0;
    document.getElementById('next-slide-btn').disabled = slideIndex === presentationData.totalSlides - 1;
    
    // Dot'larƒ± g√ºncelle
    document.querySelectorAll('.slide-dot').forEach((dot, index) => {
        dot.classList.toggle('active', index === slideIndex);
    });
    
    presentationData.currentSlide = slideIndex;
}

// Sunum event listener'larƒ±nƒ± kur
function setupPresentationEventListeners() {
    // √ñnceki slayt
    document.getElementById('prev-slide-btn').addEventListener('click', () => {
        if (presentationData.currentSlide > 0) {
            showSlide(presentationData.currentSlide - 1);
        }
    });
    
    // Sonraki slayt
    document.getElementById('next-slide-btn').addEventListener('click', () => {
        if (presentationData.currentSlide < presentationData.totalSlides - 1) {
            showSlide(presentationData.currentSlide + 1);
        }
    });
    
    // Klavye navigasyonu
    document.addEventListener('keydown', (e) => {
        if (document.getElementById('presentationModal').classList.contains('show')) {
            if (e.key === 'ArrowLeft' && presentationData.currentSlide > 0) {
                showSlide(presentationData.currentSlide - 1);
            } else if (e.key === 'ArrowRight' && presentationData.currentSlide < presentationData.totalSlides - 1) {
                showSlide(presentationData.currentSlide + 1);
            }
        }
    });
    
    // Sunum indirme
    document.getElementById('download-presentation-btn').addEventListener('click', downloadPresentation);
}

// Fotoƒüraf placeholder ekle
function addPhotoPlaceholder(slide, x, y, photoNumber) {
    slide.addText(`Fotoƒüraf ${photoNumber}\nY√ºklenemedi`, {
        x: x, y: y, w: 1.2, h: 1.2,
        fontSize: 12,
        color: '000000',
        align: 'center',
        fontFace: 'Arial',
        fill: { color: 'F0F0F0' },
        border: { color: 'CCCCCC', pt: 1 }
    });
}

// Sunumu indir
async function downloadPresentation() {
    console.log('üì• PowerPoint sunumu indiriliyor...');
    
    try {
        // PowerPoint sunumu olu≈ütur
        const pptx = new PptxGenJS();
        
        // Sunum bilgilerini al
        const surveyName = investmentReportData.surveys.find(s => 
            investmentReportData.currentFilters.surveys.includes(s.id.toString())
        )?.title || 'Anket';
        
        const currentDate = new Date().toLocaleDateString('tr-TR');
        
        // 1. Giri≈ü Slaytƒ±
        const introSlide = pptx.addSlide();
        introSlide.background = { fill: '667eea' };
        
        introSlide.addText('ANKET SONU√áLARI', {
            x: 1, y: 2, w: 8, h: 1,
            fontSize: 48,
            color: 'FFFFFF',
            bold: true,
            align: 'center',
            fontFace: 'Arial'
        });
        
        introSlide.addText(surveyName, {
            x: 1, y: 3.5, w: 8, h: 0.8,
            fontSize: 32,
            color: 'FFFFFF',
            align: 'center',
            fontFace: 'Arial'
        });
        
        introSlide.addText(`Tarih: ${currentDate}`, {
            x: 1, y: 4.8, w: 8, h: 0.6,
            fontSize: 24,
            color: 'FFFFFF',
            align: 'center',
            fontFace: 'Arial'
        });
        
        introSlide.addText('Marka Bazlƒ± Yatƒ±rƒ±m Alanlarƒ±', {
            x: 1, y: 5.8, w: 8, h: 0.6,
            fontSize: 20,
            color: 'FFFFFF',
            align: 'center',
            fontFace: 'Arial'
        });
        
        // T√ºm fotoƒüraflarƒ± √∂nce y√ºkle
        console.log('üì∏ Fotoƒüraflar y√ºkleniyor...');
        const photoPromises = [];
        
        presentationData.slides.forEach((slide, slideIndex) => {
            slide.stores.forEach((store, storeIndex) => {
                const photosToShow = store.photos.slice(0, 4);
                photosToShow.forEach((photo, photoIndex) => {
                    if (photo && photo.trim() !== '') {
                        photoPromises.push(loadPhotoForPowerPoint(photo));
                    }
                });
            });
        });
        
        // T√ºm fotoƒüraflarƒ± bekle
        const loadedPhotos = await Promise.allSettled(photoPromises);
        console.log('‚úÖ Fotoƒüraflar y√ºklendi:', loadedPhotos.length);
        
        // Marka slaytlarƒ± olu≈ütur
        let globalPhotoIndex = 0;
        presentationData.slides.forEach((slide, slideIndex) => {
            const brandSlide = pptx.addSlide();
            brandSlide.background = { fill: 'FFFFFF' };
            
            // Marka ba≈ülƒ±ƒüƒ±
            brandSlide.addText(slide.brand, {
                x: 0.5, y: 0.5, w: 9, h: 1,
                fontSize: 44,
                color: '000000',
                bold: true,
                align: 'center',
                fontFace: 'Arial'
            });
            
            brandSlide.addText('Marka Yatƒ±rƒ±m Alanlarƒ±', {
                x: 0.5, y: 1.2, w: 9, h: 0.5,
                fontSize: 20,
                color: '000000',
                align: 'center',
                fontFace: 'Arial'
            });
            
            // Maƒüaza kartlarƒ± (3'l√º grid)
            slide.stores.forEach((store, storeIndex) => {
                const x = 0.5 + (storeIndex * 3);
                const y = 2;
                
                // Maƒüaza adƒ±
                brandSlide.addText(store.storeName, {
                    x: x, y: y, w: 2.5, h: 0.4,
                    fontSize: 18,
                    color: '000000',
                    bold: true,
                    align: 'center',
                    fontFace: 'Arial'
                });
                
                // Marka rozeti
                brandSlide.addText(store.brand, {
                    x: x, y: y + 0.4, w: 2.5, h: 0.3,
                    fontSize: 14,
                    color: '000000',
                    align: 'center',
                    fontFace: 'Arial',
                    fill: { color: 'F0F0F0', opacity: 50 }
                });
                
                // Fotoƒüraflar (2x2 grid) - Daha b√ºy√ºk boyutlar
                const photosToShow = store.photos.slice(0, 4);
                photosToShow.forEach((photo, photoIndex) => {
                    const photoX = x + (photoIndex % 2) * 1.3;
                    const photoY = y + 0.8 + Math.floor(photoIndex / 2) * 1.4;
                    
                    if (photo && photo.trim() !== '') {
                        const photoResult = loadedPhotos[globalPhotoIndex];
                        if (photoResult.status === 'fulfilled' && photoResult.value) {
                            try {
                                brandSlide.addImage({
                                    data: photoResult.value,
                                    x: photoX, y: photoY, w: 1.2, h: 1.2,
                                    sizing: { type: 'cover', w: 1.2, h: 1.2 }
                                });
                                console.log('‚úÖ Fotoƒüraf PowerPoint\'e eklendi:', globalPhotoIndex);
                            } catch (error) {
                                console.warn('‚ùå Fotoƒüraf PowerPoint\'e eklenemedi:', error);
                                addPhotoPlaceholder(brandSlide, photoX, photoY, photoIndex + 1);
                            }
                        } else {
                            console.warn('‚ùå Fotoƒüraf y√ºklenemedi:', photo);
                            addPhotoPlaceholder(brandSlide, photoX, photoY, photoIndex + 1);
                        }
                        globalPhotoIndex++;
                    } else {
                        addPhotoPlaceholder(brandSlide, photoX, photoY, photoIndex + 1);
                    }
                });
                
                // Fotoƒüraf sayƒ±sƒ±
                if (store.photos.length > 4) {
                    brandSlide.addText(`+${store.photos.length - 4}`, {
                        x: x + 1.2, y: y + 0.8, w: 0.3, h: 0.3,
                        fontSize: 12,
                        color: '000000',
                        bold: true,
                        align: 'center',
                        fontFace: 'Arial',
                        fill: { color: 'FFFFFF', opacity: 70 }
                    });
                }
                
                // B√∂lge-Kanal bilgisi
                brandSlide.addText(`${store.regionName} - ${store.channelName}`, {
                    x: x, y: y + 3.4, w: 2.5, h: 0.3,
                    fontSize: 12,
                    color: '000000',
                    align: 'center',
                    fontFace: 'Arial'
                });
            });
        });
        
        // Sunumu indir
        const fileName = `Anket_Sunumu_${surveyName.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pptx`;
        
        await pptx.writeFile({ fileName: fileName });
        showAlert('PowerPoint sunumu ba≈üarƒ±yla indirildi!', 'success');
        console.log('‚úÖ PowerPoint sunumu indirildi:', fileName);
        
    } catch (error) {
        console.error('‚ùå Sunum olu≈üturma hatasƒ±:', error);
        showAlert('Sunum olu≈üturulurken hata olu≈ütu: ' + error.message, 'error');
    }
}

// Fotoƒürafƒ± PowerPoint i√ßin y√ºkle ve rotasyonu d√ºzelt
async function loadPhotoForPowerPoint(photoUrl) {
    try {
        if (photoUrl.startsWith('data:image/')) {
            // Base64 formatƒ±nda - rotasyonu d√ºzelt
            return await fixImageOrientation(photoUrl);
        } else {
            // URL formatƒ±nda - fetch ile y√ºkle ve rotasyonu d√ºzelt
            const response = await fetch(photoUrl);
            if (response.ok) {
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async () => {
                        try {
                            const fixedImage = await fixImageOrientation(reader.result);
                            resolve(fixedImage);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } else {
                throw new Error('Fotoƒüraf y√ºklenemedi');
            }
        }
    } catch (error) {
        console.warn('‚ùå Fotoƒüraf y√ºkleme hatasƒ±:', photoUrl, error);
        return null;
    }
}

// Fotoƒüraf rotasyonunu d√ºzelt
async function fixImageOrientation(dataUrl) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Canvas boyutlarƒ±nƒ± ayarla
            canvas.width = img.width;
            canvas.height = img.height;
            
            // Fotoƒürafƒ± canvas'a √ßiz
            ctx.drawImage(img, 0, 0);
            
            // Canvas'ƒ± Base64'e √ßevir
            const fixedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
            resolve(fixedDataUrl);
        };
        img.onerror = reject;
        img.src = dataUrl;
    });
}

// Excel export fonksiyonu
async function exportInvestmentToExcel() {
    try {
        console.log('üìä Excel export ba≈ülatƒ±lƒ±yor...');
        
        const loadingId = showLoading('Excel Export', 'Veriler hazƒ±rlanƒ±yor...');
        
        // Filtrelenmi≈ü veriyi al
        const filteredData = investmentReportData.filteredData || [];
        
        if (filteredData.length === 0) {
            hideLoading(loadingId);
            showAlert('Export edilecek veri bulunamadƒ±', 'warning');
            return;
        }
        
        updateLoading(loadingId, 'Excel Export', 'Excel dosyasƒ± olu≈üturuluyor...');
        
        // Excel workbook olu≈ütur
        const wb = XLSX.utils.book_new();
        
        // Veri hazƒ±rlama
        const excelData = [];
        
        // Ba≈ülƒ±k satƒ±rƒ±
        excelData.push([
            'Maƒüaza ID',
            'Maƒüaza Adƒ±',
            'B√∂lge',
            'Kanal',
            'Anket ID',
            'Marka',
            'Alan Tipi',
            'Fotoƒüraf 1',
            'Fotoƒüraf 2',
            'Fotoƒüraf 3',
            'Fotoƒüraf 4',
            'Fotoƒüraf 5'
        ]);
        
        // Veri satƒ±rlarƒ±
        for (const item of filteredData) {
            const store = investmentReportData.stores.find(s => s.id === item.store_id);
            const region = investmentReportData.regions.find(r => r.id === store?.region_id);
            const channel = investmentReportData.channels.find(c => c.id === store?.channel_id);
            
            for (const area of item.areas) {
                const photos = area.photos || [];
                const row = [
                    item.store_id,
                    store?.name || 'Bilinmiyor',
                    region?.name || 'Bilinmiyor',
                    channel?.name || 'Bilinmiyor',
                    item.survey_id,
                    area.brand,
                    area.area_type || area.areaType || 'wall',
                    photos[0] || '',
                    photos[1] || '',
                    photos[2] || '',
                    photos[3] || '',
                    photos[4] || ''
                ];
                excelData.push(row);
            }
        }
        
        // Worksheet olu≈ütur
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        
        // Kolon geni≈üliklerini ayarla
        ws['!cols'] = [
            { wch: 10 }, // Maƒüaza ID
            { wch: 25 }, // Maƒüaza Adƒ±
            { wch: 15 }, // B√∂lge
            { wch: 15 }, // Kanal
            { wch: 10 }, // Anket ID
            { wch: 15 }, // Marka
            { wch: 15 }, // Alan Tipi
            { wch: 20 }, // Fotoƒüraf 1
            { wch: 20 }, // Fotoƒüraf 2
            { wch: 20 }, // Fotoƒüraf 3
            { wch: 20 }, // Fotoƒüraf 4
            { wch: 20 }  // Fotoƒüraf 5
        ];
        
        // Workbook'a worksheet ekle
        XLSX.utils.book_append_sheet(wb, ws, 'Yatƒ±rƒ±m Alanƒ± Raporu');
        
        updateLoading(loadingId, 'Excel Export', 'Dosya indiriliyor...');
        
        // Dosyayƒ± indir
        const fileName = `Yatirim_Alani_Raporu_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        hideLoading(loadingId);
        showAlert('Excel dosyasƒ± ba≈üarƒ±yla indirildi!', 'success');
        
        console.log('‚úÖ Excel export tamamlandƒ±:', fileName);
        
    } catch (error) {
        console.error('‚ùå Excel export hatasƒ±:', error);
        showAlert('Excel export sƒ±rasƒ±nda hata olu≈ütu: ' + error.message, 'error');
        if (loadingId) hideLoading(loadingId);
    }
}

// Sayfa y√ºklendiƒüinde ba≈ülat
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìÑ DOM y√ºklendi, Yatƒ±rƒ±m Alanƒ± Raporu ba≈ülatƒ±lƒ±yor...');
    
    // Supabase'in y√ºklenmesini bekle
    if (typeof supabase !== 'undefined') {
        initializeInvestmentReport();
    } else {
        console.log('‚è≥ Supabase y√ºklenmesi bekleniyor...');
        const checkSupabase = setInterval(() => {
            if (typeof supabase !== 'undefined') {
                clearInterval(checkSupabase);
                initializeInvestmentReport();
            }
        }, 100);
    }
});