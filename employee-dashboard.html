<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mağaza Paneli - Kampanya Takip Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Üst Menü -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-store me-2"></i>
                Kampanya Takip Sistemi - Mağaza Paneli
            </a>
            <button class="navbar-toggler d-md-none" type="button" onclick="toggleSidebar()">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" id="user-info">
                    <i class="fas fa-user me-1"></i>
                    <span id="user-name">Kullanıcı Adı</span>
                </span>
                <a class="nav-link" href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i>Çıkış
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sol Menü -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar" id="sidebar">
                <div class="position-sticky pt-3">
                    <!-- Mobil Menü Butonu -->
                    <div class="d-md-none text-center mb-3">
                        <button class="btn btn-outline-primary btn-sm" onclick="toggleSidebar()">
                            <i class="fas fa-bars me-1"></i>Menü
                        </button>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#tasks" onclick="showSection('tasks')">
                                <i class="fas fa-tasks me-2"></i>Görevlerim
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#sales-entry" onclick="showSection('sales-entry')">
                                <i class="fas fa-shopping-cart me-2"></i>Satış Girişi
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#completed" onclick="showSection('completed')">
                                <i class="fas fa-check-circle me-2"></i>Tamamlanan
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#surveys" onclick="showSection('surveys')">
                                <i class="fas fa-clipboard-list me-2"></i>Anketlerim
                                <span id="pending-surveys-badge" class="badge bg-danger ms-2" style="display: none;">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#price-tracking" onclick="showSection('price-tracking')">
                                <i class="fas fa-tag me-2"></i>Fiyat Takibi
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#investment-photos" onclick="showSection('investment-photos')">
                                <i class="fas fa-camera me-2"></i>Yatırım Alanları Fotoğraf
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#product-check" onclick="showSection('product-check')">
                                <i class="fas fa-check-square me-2"></i>Ürün Kontrolü
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#profile" onclick="showSection('profile')">
                                <i class="fas fa-user me-2"></i>Profil
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="changeStore()">
                                <i class="fas fa-exchange-alt me-2"></i>Mağaza Değiştir
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Ana İçerik -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2" id="page-title">Görevlerim</h1>
                </div>

                <!-- Görevler İçeriği -->
                <div id="tasks-section" class="content-section">
                    <div class="row" id="tasks-container">
                        <!-- Görevler buraya dinamik olarak eklenecek -->
                    </div>
                </div>

                <!-- Tamamlanan Görevler İçeriği -->
                <div id="completed-section" class="content-section" style="display: none;">
                    <div class="row" id="completed-tasks-container">
                        <!-- Tamamlanan görevler buraya eklenecek -->
                    </div>
                </div>

                <!-- Anketler İçeriği -->
                <div id="surveys-section" class="content-section" style="display: none;">
                    <div class="row">
                        <!-- Bekleyen Anketler -->
                        <div class="col-md-6 mb-4">
                            <div class="card shadow-sm h-100">
                                <div class="card-header bg-warning text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-hourglass-half me-2"></i>Bekleyen Anketler
                                    </h5>
                                </div>
                                <div class="card-body" id="pending-surveys-container">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Yükleniyor...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tamamlanan Anketler -->
                        <div class="col-md-6 mb-4">
                            <div class="card shadow-sm h-100">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-check-circle me-2"></i>Tamamlanan Anketler
                                    </h5>
                                </div>
                                <div class="card-body" id="completed-surveys-container">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Yükleniyor...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fiyat Takibi İçeriği -->
                <div id="price-tracking-section" class="content-section" style="display: none;">
                    <div class="card shadow">
                        <div class="card-header">
                            <h5 class="mb-0">Rakip Fiyat Takibi</h5>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-primary mb-3" onclick="showAddPriceForm()">
                                <i class="fas fa-plus me-2"></i>Yeni Fiyat Kaydı Ekle
                            </button>
                            
                            <!-- Fiyat Ekleme Formu -->
                            <div id="add-price-form" style="display: none;" class="mb-4">
                                <form id="price-form" onsubmit="submitPriceTracking(event)">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <h6 class="text-muted">Rakip Bilgileri</h6>
                                            <div class="mb-3">
                                                <label class="form-label">Rakip Marka *</label>
                                                <select class="form-select" id="competitor-brand" required>
                                                    <option value="">Marka Seçiniz</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Rakip Ürün Adı *</label>
                                                <input type="text" class="form-control" id="competitor-product" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Rakip Artikel No</label>
                                                <input type="text" class="form-control" id="competitor-artikel">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Rakip Fiyat (TL) *</label>
                                                <input type="number" step="0.01" class="form-control" id="competitor-price" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <h6 class="text-muted">Bizim Ürün Bilgileri</h6>
                                            <div class="mb-3">
                                                <label class="form-label">Bizim Marka *</label>
                                                <select class="form-select" id="our-brand" required>
                                                    <option value="">Marka Seçiniz</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Bizim Ürün Adı *</label>
                                                <input type="text" class="form-control" id="our-product" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Bizim Artikel No</label>
                                                <input type="text" class="form-control" id="our-artikel">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Bizim Fiyat (TL) *</label>
                                                <input type="number" step="0.01" class="form-control" id="our-price" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Notlar</label>
                                        <textarea class="form-control" id="price-notes" rows="2"></textarea>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-save me-2"></i>Kaydet
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="hideAddPriceForm()">
                                            İptal
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Fiyat Kayıtları Listesi -->
                            <div id="price-tracking-list">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Yükleniyor...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Satış Girişi İçeriği -->
                <div id="sales-entry-section" class="content-section" style="display: none;">
                    <div class="card shadow">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Satış Girişi</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Satış girişi formu yükleniyor...</p>
                            <div id="sales-entry-content"></div>
                        </div>
                    </div>
                </div>

                <!-- Yatırım Alanları Fotoğraf Yükleme İçeriği -->
                <div id="investment-photos-section" class="content-section" style="display: none;">
                    <div class="card shadow">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-camera me-2"></i>Yatırım Alanları Haftalık Fotoğraf Yükleme
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Haftada 2 kere yatırım alanlarınızın fotoğraflarını yükleyin. Fotoğraflar otomatik olarak ilgili yatırım alanına ve haftalık kayda bağlanacaktır.
                            </div>

                            <form id="investment-photo-form" onsubmit="uploadWeeklyInvestmentPhoto(event)">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Yatırım Alanı *</label>
                                        <select class="form-select" id="photo-investment-area" required onchange="loadWeeklyProducts()">
                                            <option value="">Yatırım Alanı Seçiniz</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Hafta *</label>
                                        <select class="form-select" id="photo-week" required>
                                            <option value="">Hafta Seçiniz</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Yıl *</label>
                                        <select class="form-select" id="photo-year" required>
                                            <option value="">Yıl Seçiniz</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Fotoğraf *</label>
                                    <input type="file" class="form-control" id="photo-file" accept="image/*" required multiple>
                                    <small class="form-text text-muted">Birden fazla fotoğraf seçebilirsiniz</small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Not (Opsiyonel)</label>
                                    <textarea class="form-control" id="photo-note" rows="2" placeholder="Fotoğraf hakkında kısa bir not ekleyebilirsiniz..."></textarea>
                                </div>

                                <div id="photo-preview-container" class="mb-3">
                                    <!-- Fotoğraf önizlemeleri buraya eklenecek -->
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-upload me-2"></i>Fotoğrafları Yükle
                                </button>
                            </form>

                            <!-- Haftalık İlerleme -->
                            <div class="mt-4">
                                <h6>Bu Hafta Yüklenen Fotoğraflar</h6>
                                <div id="weekly-progress-container">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Yükleniyor...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ürün Kontrolü İçeriği -->
                <div id="product-check-section" class="content-section" style="display: none;">
                    <div class="card shadow">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-check-square me-2"></i>Yatırım Alanı Ürün Kontrolü
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Yatırım alanındaki planlanan ürünlerin mevcut durumunu kontrol edin. Eksik ürünler için neden belirtin.
                            </div>

                            <form id="product-check-form" onsubmit="submitProductCheck(event)">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Yatırım Alanı *</label>
                                        <select class="form-select" id="check-investment-area" required onchange="loadProductsForCheck()">
                                            <option value="">Yatırım Alanı Seçiniz</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Hafta *</label>
                                        <select class="form-select" id="check-week" required>
                                            <option value="">Hafta Seçiniz</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Yıl *</label>
                                        <select class="form-select" id="check-year" required>
                                            <option value="">Yıl Seçiniz</option>
                                        </select>
                                    </div>
                                </div>

                                <div id="products-check-container" class="mb-3">
                                    <!-- Ürünler buraya dinamik olarak eklenecek -->
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Genel Yorum (Opsiyonel)</label>
                                    <textarea class="form-control" id="check-comment" rows="3" placeholder="Yatırım alanı hakkında genel bir yorum ekleyebilirsiniz..."></textarea>
                                </div>

                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-2"></i>Kontrolü Kaydet
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Profil İçeriği -->
                <div id="profile-section" class="content-section" style="display: none;">
                    <div class="card shadow">
                        <div class="card-header">
                            <h5 class="mb-0">Profil Bilgileri</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Ad Soyad:</strong> <span id="profile-name">-</span></p>
                                    <p><strong>E-posta:</strong> <span id="profile-email">-</span></p>
                                    <p><strong>Mağaza:</strong> <span id="profile-store">-</span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Rol:</strong> <span id="profile-role">-</span></p>
                                    <p><strong>Kayıt Tarihi:</strong> <span id="profile-date">-</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Anket Wizard Modal -->
    <div class="modal fade" id="surveyWizardModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="surveyWizardTitle">Anket</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="confirmCloseSurvey()"></button>
                </div>
                <div class="modal-body">
                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted"><span id="current-question-num">1</span> / <span id="total-questions">10</span></span>
                            <span class="text-muted" id="progress-percentage">10%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" role="progressbar" id="survey-progress-bar" style="width: 10%"></div>
                        </div>
                    </div>
                    
                    <!-- Soru Konteyneri -->
                    <div id="survey-question-container">
                        <!-- Sorular dinamik olarak buraya yüklenecek -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="prev-question-btn" onclick="previousQuestion()" style="display: none;">
                        <i class="fas fa-arrow-left me-2"></i>Geri
                    </button>
                    <button type="button" class="btn btn-primary" id="next-question-btn" onclick="nextQuestion()">
                        İleri<i class="fas fa-arrow-right ms-2"></i>
                    </button>
                    <button type="button" class="btn btn-success" id="submit-survey-btn" onclick="submitSurvey()" style="display: none;">
                        <i class="fas fa-check me-2"></i>Anketi Tamamla
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Görev Detay Modal -->
    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskModalTitle">Görev Detayı</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Görev Bilgileri</h6>
                            <p><strong>Kategori:</strong> <span id="modal-category">-</span></p>
                            <p><strong>Başlangıç:</strong> <span id="modal-start-date">-</span></p>
                            <p><strong>Bitiş:</strong> <span id="modal-end-date">-</span></p>
                            <p><strong>Durum:</strong> <span id="modal-status">-</span></p>
                        </div>
                        <div class="col-md-6">
                            <h6>Görev Açıklaması</h6>
                            <p id="modal-description">-</p>
                        </div>
                    </div>
                    
                    <!-- Örnek Fotoğraf Bölümü -->
                    <div class="row mt-3" id="example-photo-section" style="display: none;">
                        <div class="col-12">
                            <h6>Örnek Fotoğraf</h6>
                            <div class="text-center">
                                <img id="modal-example-photo" src="" alt="Örnek Fotoğraf" class="img-fluid rounded" style="max-height: 300px; max-width: 100%;">
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-12">
                            <h6>Fotoğraf Yükleme</h6>
                            <div class="mb-3">
                                <label class="form-label">Fotoğraf Seçin (1-5 adet)</label>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="openGallery()">
                                        <i class="fas fa-images me-1"></i>Galeriden Fotoğraf Seç
                                    </button>
                                </div>
                                <input type="file" class="form-control d-none" id="gallery-upload" multiple accept="image/*,image/jpeg,image/jpg,image/png,image/gif,image/webp">
                                <div class="form-text">Maksimum 5 fotoğraf yükleyebilirsiniz. Her fotoğraf maksimum 20MB olmalıdır. Fotoğraflar otomatik olarak sıkıştırılacaktır.</div>
                            </div>
                            
                            <div id="photo-preview" class="row">
                                <!-- Fotoğraf önizlemeleri buraya eklenecek -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Yorum</h6>
                            <textarea class="form-control" id="task-comment" rows="3" placeholder="Görev hakkında yorum yazın..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                    <button type="button" class="btn btn-success" onclick="completeTask()">Görevi Tamamla</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/loading-system.js"></script>
    <script src="js/app.js?v=6.0"></script>
    <script src="js/employee.js?v=2.0"></script>
    <script src="js/employee-investment.js"></script>
    <script src="js/survey.js?v=6.2"></script>
    <script src="js/sales-entry.js"></script>
    
    <!-- Service Worker Registration - DEVRE DIŞI -->
    <script>
        // Service Worker'ı tamamen devre dışı bırak - Güvenli versiyon (sadece HTTP/HTTPS için)
        (function() {
            // Sadece HTTP veya HTTPS protokolünde çalış
            if (location.protocol === 'http:' || location.protocol === 'https:') {
                // Hemen çalıştır
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations()
                        .then(registrations => {
                            registrations.forEach(registration => {
                                registration.unregister();
                                console.log('Service Worker kaldırıldı:', registration);
                            });
                        })
                        .catch(error => {
                            console.log('Service Worker zaten temiz');
                        });
                }
                
                // Cache'leri temizle
                if ('caches' in window) {
                    caches.keys()
                        .then(cacheNames => {
                            cacheNames.forEach(cacheName => {
                                caches.delete(cacheName);
                                console.log('Cache temizlendi:', cacheName);
                            });
                        })
                        .catch(error => {
                            console.log('Cache zaten temiz');
                        });
                }
            } else {
                console.log('File protokolü tespit edildi, Service Worker işlemleri atlandı');
            }
            
            // Local storage'dan service worker verilerini temizle
            try {
                localStorage.removeItem('sw-cache');
                localStorage.removeItem('service-worker-cache');
                sessionStorage.clear();
                console.log('Local storage temizlendi');
            } catch (e) {
                console.warn('Local storage temizleme hatası:', e);
            }
        })();
        
        // Sayfa yüklendiğinde tekrar temizle - Güvenli versiyon
        window.addEventListener('load', () => {
            if (location.protocol === 'http:' || location.protocol === 'https:') {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations()
                        .then(registrations => {
                            registrations.forEach(registration => {
                                registration.unregister();
                                console.log('Service Worker kaldırıldı (load):', registration);
                            });
                        })
                        .catch(error => {
                            console.log('Service Worker zaten temiz (load)');
                        });
                }
                
                if ('caches' in window) {
                    caches.keys()
                        .then(cacheNames => {
                            cacheNames.forEach(cacheName => {
                                caches.delete(cacheName);
                                console.log('Cache temizlendi (load):', cacheName);
                            });
                        })
                        .catch(error => {
                            console.log('Cache zaten temiz (load)');
                        });
                }
                
                console.log('Service Worker tamamen devre dışı bırakıldı');
            }
        });
        
        // Sayfa yüklendiğinde görevler bölümünü aç - ÇİFT YÜKLEME ÖNLEM
        let isInitialLoad = true;
        window.addEventListener('load', () => {
            if (isInitialLoad) {
                isInitialLoad = false;
                setTimeout(() => {
                    if (typeof showSection === 'function') {
                        showSection('tasks');
                    }
                }, 500);
            }
        });
    </script>
</body>
</html>

